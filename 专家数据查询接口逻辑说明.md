# 专家数据查询接口逻辑说明

## 一、接口概览

### 1.1 统计接口
- **接口路径**: `GET /expert-cert-statistics/statistics`
- **请求参数**: `deptCode` (部门编码，必填)
- **返回结果**: 专家认证统计数据（仅统计L2成熟度）

### 1.2 Debug接口
- **接口路径**: `GET /expert-cert-statistics/debug`
- **请求参数**: `deptCode` (部门编码，必填)
- **返回结果**: 专家原始数据列表（包含所有成熟度，包含hasCert字段）

---

## 二、接口处理流程

### 2.1 Controller层（ExpertCertStatisticsController）

#### 统计接口流程：
```
1. 接收请求参数 deptCode
2. 参数校验：deptCode不能为空
3. 调用Service层方法 getExpertCertStatistics(deptCode)
4. 异常处理：
   - IllegalArgumentException -> 返回400错误
   - 其他异常 -> 返回500错误
5. 返回成功结果
```

#### Debug接口流程：
```
1. 接收请求参数 deptCode
2. 参数校验：deptCode不能为空
3. 查询部门信息
4. 根据部门层级调用不同的查询方法
5. 返回专家原始数据列表
```

---

## 三、Service层逻辑（ExpertCertStatisticsService）

### 3.1 核心方法：getExpertCertStatistics()

#### 步骤1：查询部门信息
```java
DepartmentInfoVO deptInfo = departmentInfoMapper.getDepartmentByCode(deptCode);
```
- 从 `department_info_hrms` 表查询部门信息
- 如果部门不存在，抛出 `IllegalArgumentException`

#### 步骤2：根据部门层级查询专家数据

**三层部门（deptLevel = "3"）：**
```java
expertList = expertCertStatisticsMapper.getExpertStatisticsByLevel3(deptCode, deptInfo.getDeptName());
```
- 使用部门名称（`org_level`）作为查询条件

**四层部门（deptLevel = "4"）：**
```java
expertList = expertCertStatisticsMapper.getExpertStatisticsByLevel4(deptCode);
```
- 使用部门编码（`l4_org_code`）作为查询条件

**其他层级：**
- 抛出异常：只支持查询三层或四层部门

#### 步骤3：构建返回结果
- 设置部门基本信息（编码、名称、层级）
- 设置专家总数：`totalExpertCount = expertList.size()`

#### 步骤4：统计L2成熟度数据（重要限制）

**只统计L2成熟度的专家：**
```java
if (!"L2".equals(aiMaturity)) {
    continue;  // 跳过非L2成熟度的专家
}
```

**统计维度：**
1. **L2成熟度总体统计**
   - 基线人数（baselineCount）：所有L2成熟度专家总数
   - 认证人数（certCount）：L2成熟度中hasCert=1的专家数
   - 认证率（certRate）：(certCount / baselineCount) * 100

2. **L2成熟度按职位类统计**
   - 按 `jobCategory` 分组统计
   - 每个职位类分别计算基线人数、认证人数、认证率

#### 步骤5：计算认证率
```java
BigDecimal rate = new BigDecimal(certCount)
    .divide(new BigDecimal(baselineCount), 4, RoundingMode.HALF_UP)
    .multiply(new BigDecimal(100));
```
- 保留4位小数
- 使用四舍五入模式

---

## 四、SQL查询逻辑

### 4.1 三层部门查询（getExpertStatisticsByLevel3）

```sql
SELECT 
    e.ai_maturity AS aiMaturity,
    e.job_category AS jobCategory,
    e.employee_number AS employeeNumber,
    CASE 
        WHEN cert.employee_number IS NOT NULL OR cert.w3_account IS NOT NULL THEN 1 
        ELSE 0 
    END AS hasCert
FROM expert_info e
LEFT JOIN (
    SELECT DISTINCT 
        COALESCE(employee_number, w3_account) AS employee_number,
        w3_account
    FROM dwr_t_cert_record_t
    WHERE (cer_title LIKE '华为研究类能力认证（专业级，%'
        OR cer_title LIKE '%华为研究类能力认证（专业级，%')
    AND (status = 1 OR approved_status = 1)
) cert ON (e.employee_number = cert.employee_number OR e.employee_number = cert.w3_account)
WHERE e.org_level = #{deptName}
AND e.on_duty_status = 1
AND e.employee_number IS NOT NULL
AND e.employee_number != ''
ORDER BY e.ai_maturity, e.job_category
```

**查询条件：**
- `e.org_level = #{deptName}` - 部门名称匹配
- `e.on_duty_status = 1` - 在岗状态
- `e.employee_number IS NOT NULL AND e.employee_number != ''` - 员工号不为空

**认证判断逻辑：**
- LEFT JOIN证书表，查询符合条件的认证记录
- 证书标题：`'华为研究类能力认证（专业级，%'` 或 `'%华为研究类能力认证（专业级，%'`
- 状态条件：`status = 1` 或 `approved_status = 1`
- 关联条件：专家表的 `employee_number` 与证书表的 `employee_number` 或 `w3_account` 匹配
- `hasCert = 1` 表示有认证，`hasCert = 0` 表示无认证

### 4.2 四层部门查询（getExpertStatisticsByLevel4）

```sql
-- 与三层查询类似，区别在于WHERE条件：
WHERE e.l4_org_code = #{deptCode}
-- 其他逻辑完全相同
```

### 4.3 部门信息查询（getDepartmentByCode）

```sql
SELECT 
    dept_code AS deptCode,
    dept_name AS deptName,
    dept_level AS deptLevel
FROM department_info_hrms
WHERE dept_code = #{deptCode}
ORDER BY dept_name DESC
LIMIT 1
```

---

## 五、数据流转图

```
请求参数(deptCode)
    ↓
Controller层
    ↓ 参数校验
Service层
    ↓
1. 查询部门信息 (department_info_hrms)
    ↓
2. 根据部门层级选择查询方法
    ↓
    ├─ 三层部门 → getExpertStatisticsByLevel3 (使用部门名称)
    └─ 四层部门 → getExpertStatisticsByLevel4 (使用部门编码)
    ↓
3. SQL查询专家数据 (expert_info)
    ↓
4. LEFT JOIN证书数据 (dwr_t_cert_record_t)
    ↓ 计算hasCert字段
5. 过滤L2成熟度数据
    ↓
6. 统计计算
    ├─ L2总体统计
    └─ L2按职位类统计
    ↓
7. 计算认证率
    ↓
返回结果
```

---

## 六、关键业务规则

### 6.1 认证通过条件
1. **证书标题匹配**：
   - `cer_title LIKE '华为研究类能力认证（专业级，%'`
   - 或 `cer_title LIKE '%华为研究类能力认证（专业级，%'`

2. **状态条件**（满足其一即可）：
   - `status = 1` （状态为1）
   - 或 `approved_status = 1` （审批状态为1）

3. **员工号匹配**：
   - 专家表的 `employee_number` = 证书表的 `employee_number`
   - 或 专家表的 `employee_number` = 证书表的 `w3_account`

### 6.2 统计限制
- **只统计L2成熟度的专家**
- L1、L3等其他成熟度的专家会被过滤掉，不参与统计
- 但会在 `totalExpertCount` 中计入总数

### 6.3 专家筛选条件
- `on_duty_status = 1` - 必须在岗
- `employee_number IS NOT NULL` - 必须有员工号
- `employee_number != ''` - 员工号不能为空字符串

---

## 七、返回数据结构

### 7.1 统计接口返回（ExpertCertStatisticsResponseVO）
```json
{
    "code": 200,
    "message": "查询成功",
    "data": {
        "deptCode": "D008",
        "deptName": "研发管理部",
        "deptLevel": "3",
        "totalExpertCount": 3,
        "maturityStatistics": [
            {
                "aiMaturity": "L2",
                "baselineCount": 1,
                "certCount": 1,
                "certRate": 100.0000
            }
        ],
        "maturityJobCategoryStatistics": [
            {
                "aiMaturity": "L2",
                "jobCategory": "软件类",
                "baselineCount": 1,
                "certCount": 1,
                "certRate": 100.0000
            }
        ]
    }
}
```

### 7.2 Debug接口返回
```json
{
    "code": 200,
    "message": "查询成功",
    "data": [
        {
            "aiMaturity": "L2",
            "jobCategory": "软件类",
            "employeeNumber": "l00000001",
            "hasCert": 1
        },
        {
            "aiMaturity": "L3",
            "jobCategory": "测试类",
            "employeeNumber": "l00000004",
            "hasCert": 1
        }
    ]
}
```

---

## 八、注意事项

1. **统计接口只返回L2成熟度数据**，但 `totalExpertCount` 包含所有成熟度的专家总数
2. **认证判断使用LEFT JOIN**，即使没有匹配的证书记录，专家也会被查询出来（hasCert=0）
3. **部门层级限制**：只支持三层和四层部门，其他层级会返回错误
4. **认证率计算**：保留4位小数，使用四舍五入
5. **员工号关联**：同时支持 `employee_number` 和 `w3_account` 两种字段匹配





