# 接口文档：同步基层主管（PL/TM）数据

## 接口概述

**接口路径**：`POST /external-api/sync-entry-level-manager`

**接口描述**：从 `t_entry_level_manager_sync` 表中筛选出当前有效的PL（基层主管）和TM数据，并同步至 `t_entry_level_manager` 表中。

**业务逻辑**：
1. 查询所有状态为有效的PL和TM人员（status='Y'）
2. 查询所有任期结束的PL和TM（status='N'）
3. 从状态为有效的PL和TM中剔除任期结束的数据，得到当前有效的PL和TM信息
4. 删除目标表中不在有效数据列表中的记录（确保目标表只保留当前有效数据）
5. 将有效PL和TM的完整数据更新到 `t_entry_level_manager` 表中（存在则更新，不存在则插入）

**常量配置**：
- `periodId` = '20251222'（数据周期ID）
- `l1DepartmentCode` = '075774'（一层组织编码，设置为常量）
- `jobNameCn` = 'PL' 或 'TM'（职位名称）

## 请求参数

**说明**：本接口无需任何请求参数，所有查询条件均为固定常量。

### 请求示例

```bash
POST /external-api/sync-entry-level-manager
```

## 响应结果

### 成功响应

```json
{
  "code": 200,
  "message": "同步成功，共同步X条有效PL/TM数据，删除Y条无效数据",
  "data": {
    "totalCount": 100,
    "expiredCount": 10,
    "validCount": 90,
    "syncedCount": 90,
    "deletedCount": 5
  }
}
```

| 字段名 | 类型 | 说明 |
|--------|------|------|
| code | Integer | 响应码，200表示成功 |
| message | String | 响应消息 |
| data | Object | 响应数据 |
| data.totalCount | Integer | 状态为有效的PL和TM人员总数 |
| data.expiredCount | Integer | 任期结束的PL和TM数量 |
| data.validCount | Integer | 当前有效的PL和TM数量 |
| data.syncedCount | Integer | 实际同步到目标表的数据条数（插入+更新） |
| data.deletedCount | Integer | 从目标表中删除的无效数据条数 |

### 失败响应

```json
{
  "code": 500,
  "message": "错误信息描述",
  "data": null
}
```

## 业务逻辑详细说明

### 1. 查询所有状态为有效的PL和TM人员

**SQL逻辑**：
```sql
SELECT s.* 
FROM t_entry_level_manager_sync s 
JOIN t_employee_sync t ON t.employee_number = s.employee_number 
WHERE s.job_name_cn IN ('PL', 'TM')
  AND t.period_id = '20251222'
  AND s.l1_department_code = '075774'
  AND s.status = 'Y'
GROUP BY s.employee_number
```

**说明**：获取所有在指定部门下状态为有效（status='Y'）的PL和TM完整数据（包含所有字段）。使用 `GROUP BY s.employee_number` 对同一员工的多条记录进行去重。所有查询条件均为固定常量。

### 2. 查询所有任期结束的PL和TM

**SQL逻辑**：
```sql
SELECT s.* 
FROM t_entry_level_manager_sync s 
JOIN t_employee_sync t ON t.employee_number = s.employee_number 
WHERE s.job_name_cn IN ('PL', 'TM')
  AND t.period_id = '20251222'
  AND s.l1_department_code = '075774'
  AND s.status = 'N'
GROUP BY s.employee_number
```

**说明**：获取所有任期已结束（status='N'）的PL和TM完整数据（包含所有字段）。使用 `GROUP BY s.employee_number` 对同一员工的多条记录进行去重。所有查询条件均为固定常量。

### 3. 计算有效PL和TM

**逻辑**：根据 `employee_number` 从"状态为有效的PL和TM人员"数据中剔除"任期结束的PL和TM"数据，得到当前有效的PL和TM完整数据列表。

### 4. 删除无效数据

**删除逻辑**：
- 查询目标表 `t_entry_level_manager` 中所有已存在的 `employee_number`
- 计算需要删除的数据：目标表中存在，但不在新的有效数据列表中的记录
- 批量删除这些无效数据

### 5. 更新数据到目标表

**更新逻辑**：
- 直接使用步骤3计算得到的有效PL和TM完整数据
- 根据 `employee_number` 判断目标表中是否存在记录
- 如果目标表中已存在相同 `employee_number` 的记录，则更新该记录；如果不存在，则插入新记录
- **注意**：同步后，目标表中只保留当前有效的PL和TM数据，不在有效列表中的数据会被删除

**更新字段**：将 `t_entry_level_manager_sync` 表中的所有字段更新到 `t_entry_level_manager` 表：
- employee_appointment_id
- employee_number
- organization_code
- organization_name_cn
- job_code
- job_name_cn
- start_date
- end_date
- status
- l1_department_code ~ l7_department_code
- l1_department_cn_name ~ l7_department_cn_name

## 注意事项

1. **数据去重**：同一个员工可能有多条任职记录，需要根据业务需求决定同步策略（是否只同步最新的一条，还是同步所有有效记录）
2. **事务处理**：建议在Service层使用事务，确保数据一致性
3. **异常处理**：需要处理数据库异常、数据校验异常等情况
4. **性能考虑**：如果数据量较大，建议分批处理或使用批量插入
5. **日志记录**：建议记录同步操作的详细日志，便于问题排查

## 待确认事项

1. **同步策略**：当同一个员工有多条PL或TM任职记录时，是同步所有记录还是只同步最新的一条？
2. **数据覆盖**：同步时是否需要先清空目标表中的旧数据，还是采用增量更新？
3. **数据范围**：是否只同步当前有效的PL数据，还是需要同步历史数据？

