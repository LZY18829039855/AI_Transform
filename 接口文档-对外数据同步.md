# 对外开放数据同步更新接口文档

## 1. 接口概述
本接口用于同步 `t_employee_sync` 表中的最新数据到 `t_employee` 表。
接口执行全量比对逻辑：查询 `t_employee` 现有数据与 `t_employee_sync` (按 `period_id` 过滤) 的最新数据进行对比，执行新增、更新或删除操作。

## 2. 接口定义

### 2.1 接口地址
- **URL**: `/external-api/sync-employee-data`
- **Method**: `POST`
- **Content-Type**: `application/json`

### 2.2 请求参数

| 参数名 | 类型 | 必填 | 说明 | 示例 |
| :--- | :--- | :--- | :--- | :--- |
| (无) | - | - | 接口自动推算数据期号 | - |

### 2.3 业务规则
1. **Period ID 推算**: 系统自动取当前服务器日期减 2 天作为 `period_id` (格式 `yyyyMMdd`)，用于从 `t_employee_sync` 获取最新源数据。
2. **同步逻辑**:
   - **源数据**: `t_employee_sync` (过滤 `period_id`) + 任职/认证/考试达标状态计算。
   - **目标数据**: `t_employee` 全量数据。
   - **比对规则** (以 `employee_number` 为主键):
     - **新增**: 源数据有，目标数据无 -> **插入**。
     - **更新**: 源数据有，目标数据有，且非忽略字段 (`period_id`, `updated_time`) 的内容不一致 -> **更新**。
     - **删除**: 源数据无，目标数据有 -> **删除**。
   - **判定一致性忽略字段**: `period_id` 不参与一致性比对。

### 2.4 响应结果

返回同步执行的统计结果。

```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "periodId": "20251228",
    "totalSource": 1000,
    "insertCount": 10,
    "updateCount": 5,
    "deleteCount": 2,
    "ignoreCount": 983
  }
}
```

## 3. 字段映射与逻辑

### 3.1 字段映射

| 目标表 (`t_employee`) | 源表/逻辑 (`t_employee_sync` 及关联表) | 说明 |
| :--- | :--- | :--- |
| employee_number | employee_number | 主键 |
| last_name | last_name | 姓名 |
| firstdeptcode | firstdeptcode | 一级部门编码 |
| seconddeptcode | seconddeptcode | 二级部门编码 |
| thirddeptcode | thirddeptcode | 三级部门编码 |
| fourthdeptcode | fourthdeptcode | 四级部门编码 |
| fifthdeptcode | fifthdeptcode | 五级部门编码 |
| sixthdeptcode | sixthdeptcode | 六级部门编码 |
| lowestdeptid | lowest_dept_number | 最小部门ID |
| firstdept | firstdept (解析) | 一级部门名称 |
| seconddept | seconddept (解析) | 二级部门名称 |
| thirddept | thirddept (解析) | 三级部门名称 |
| fourthdept | fourthdept (解析) | 四级部门名称 |
| fifthdept | fifthdept (解析) | 五级部门名称 |
| sixthdept | sixthdept (解析) | 六级部门名称 |
| lowestdept | lowest_dept | 最小部门名称 |
| job_type | job_category (解析) | 职位族 |
| job_category | job_category (解析) | 职位类 |
| job_subcategory | job_category (解析) | 职位子类 |
| period_id | period_id | 数据期号 (不参与一致性对比) |
| updated_time | (系统当前时间) | 更新时间 |
| is_qualifications_standard | (计算逻辑) | 任职是否达标 |
| is_cert_standard | (计算逻辑) | 认证是否达标 |
| cert_title | dwr_t_cert_record_t.cer_title | 证书名称 (特定AI证书) |
| is_passed_subject2 | t_exam_record (逻辑判定) | 是否通过科目2 (1:是, 0:否) |
| competence_family_cn | t_qualifications.competence_family_cn | 专业任职资格族 |
| competence_category_cn | t_qualifications.competence_category_cn | 专业任职资格类（仅体现AI） |
| competence_subcategory_cn | t_qualifications.competence_subcategory_cn | 专业任职资格子类 |
| direction_cn_name | t_qualifications.direction_cn_name | 资格方向 |
| competence_rating_cn | t_qualifications.competence_rating_cn | 资格级别 |
| competence_from | t_qualifications.competence_from | 生效日期 |
| competence_to | t_qualifications.competence_to | 失效日期 |

### 3.2 达标判定与详细字段获取逻辑

#### 1. 任职与认证达标 (原有逻辑)
(同原文档，此处省略详细描述，保持与 `employee-cert-statistics` 一致)

#### 2. 证书名称 (`cert_title`)
- **来源表**: `dwr_t_cert_record_t`
- **关联条件**: `employee_number`
- **过滤条件**: 
  - 状态有效: `status = 1` 或 `approved_status = 1`
  - 证书名称匹配以下任意一个:
    - `华为研究类能力认证（专业级，AI算法技术）`
    - `华为研究类能力认证（专业级，AI决策推理）`
    - `华为研究类能力认证（专业级，AI图像语言语义）`
- **取值规则**: 若存在匹配记录，取其 `cer_title`；若有多条，取任意一条（建议按 `start_time` 倒序取最新的）。若无匹配，置为 `NULL`。

#### 3. 是否通过科目2 (`is_passed_subject2`)
- **来源表**: `t_exam_record`
- **关联条件**: `employee_number` = `emp_num`
- **过滤条件**: 
  - `is_pass = 1` (考试通过)
  - `exam_name` 不为空
- **取值规则**: 若存在满足条件的记录，字段值为 `1`；否则为 `0` (或 `NULL`，根据数据库定义，建议默认为 `0` 或 `NULL` 均可，保持一致性)。
- **参考逻辑**: 依据 `person-cert-details` 接口全员查询逻辑 (`EmployeeMapper.getEmployeeCertDetailsByDeptLevel`)。

#### 4. 任职详细信息 (新增字段)
- **来源表**: `t_qualifications`
- **关联条件**: `employee_number`
- **过滤条件**:
  - `direction_cn_name` 必须在以下范围内 (AI相关):
    - `数据科学与AI工程（ICT）`
    - `AI算法及应用（ICT）`
    - `AI软件工程与工具（ICT）`
    - `AI系统测试（ICT）`
  - `competence_from` 和 `competence_to` 不为空
- **排序与选取规则**:
  - 每个员工可能有多条任职记录，需选取**最高级别**的一条。
  - **级别优先级 (由高到低)**: `8级` > `7级` > `6级` > `5级` > `4级` > `3级` > `2级` > `1级` > `初级` > 其他
  - 若级别相同，取 `competence_from` 最新的一条。
  - 注意：查询时**不应限制** `CURDATE() BETWEEN competence_from AND competence_to`（即包含已过期的记录，与 `cadre-qualified-details` 逻辑一致），或者根据业务需求确认是否仅取有效任职。此处建议与 `cadre-qualified-details` 保持一致，取历史最高任职。
- **字段映射**:
  - `competence_family_cn`: 专业任职资格族
  - `competence_category_cn`: 专业任职资格类
  - `competence_subcategory_cn`: 专业任职资格子类
  - `direction_cn_name`: 资格方向
  - `competence_rating_cn`: 资格级别
  - `competence_from`: 生效日期
  - `competence_to`: 失效日期
