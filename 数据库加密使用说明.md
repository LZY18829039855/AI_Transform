# 数据库信息加密使用说明

## 概述

本项目已集成通用字符串加密功能，支持在配置文件中使用加密格式存储敏感信息。目前主要用于数据库用户名和密码的加密，但底层实现支持加密任何类型的字符串（如API Token、密钥等），避免明文存储敏感信息。

## 加密格式

配置文件中的用户名和密码都支持以下两种格式：

1. **明文格式**（不推荐）：
   ```yaml
   username: root
   password: admin123
   ```

2. **加密格式**（推荐）：
   ```yaml
   username: ENC(加密后的用户名字符串)
   password: ENC(加密后的密码字符串)
   ```

系统会自动识别 `ENC(...)` 格式，并在启动时自动解密。

## 使用方法

### 方法一：使用加密工具（推荐）

1. **编译项目**：
   ```bash
   mvn compile
   ```

2. **运行加密工具**：
   ```bash
   # Windows PowerShell
   java -cp target/classes com.huawei.aitransform.util.PasswordEncryptor
   
   # 或者使用Maven
   mvn exec:java -Dexec.mainClass="com.huawei.aitransform.util.PasswordEncryptor"
   ```

3. **选择要加密的内容**：
   - 输入 `1` 加密用户名
   - 输入 `2` 加密密码
   - 输入 `3` 加密其他字符串（如Token、API密钥等）
   - 输入 `exit` 退出

4. **输入要加密的内容**，工具会输出加密后的字符串，格式如：`ENC(xxxxxx)`

5. **将输出的加密字符串复制到 `application.yml`**：
   ```yaml
   username: ENC(加密后的用户名)
   password: ENC(加密后的密码)
   ```

### 方法二：命令行参数方式

#### 加密用户名：
```bash
java -cp target/classes com.huawei.aitransform.util.PasswordEncryptor username your_username
```

#### 加密密码：
```bash
java -cp target/classes com.huawei.aitransform.util.PasswordEncryptor password your_password
```

#### 加密其他字符串（如Token、API密钥等）：
```bash
java -cp target/classes com.huawei.aitransform.util.PasswordEncryptor token your_token_string
```

#### 向后兼容（只加密密码）：
```bash
java -cp target/classes com.huawei.aitransform.util.PasswordEncryptor your_password
```

工具会直接输出加密后的内容。

## 加密密钥配置

### 默认密钥

如果不设置密钥，系统会使用默认密钥。**生产环境强烈建议使用自定义密钥！**

### 自定义密钥方式

#### 方式一：环境变量（推荐）

**Windows PowerShell:**
```powershell
$env:CRYPTO_KEY="your_custom_key_here"
```

**Windows CMD:**
```cmd
set CRYPTO_KEY=your_custom_key_here
```

**Linux/Mac:**
```bash
export CRYPTO_KEY=your_custom_key_here
```

#### 方式二：Java系统属性

```bash
java -Dcrypto.key=your_custom_key_here -jar your-app.jar
```

#### 方式三：生成新密钥

运行以下代码可以生成一个新的随机密钥：

```java
String key = CryptoUtil.generateKey();
System.out.println(key);
```

**重要提示：**
- 密钥长度建议至少16个字符
- 密钥一旦设置，必须保持一致，否则无法解密已加密的密码
- 建议将密钥保存在安全的地方（如密钥管理服务），不要提交到代码仓库

## 示例

### 1. 加密用户名 "root"

运行工具后选择 `1`，输入 `root`，假设输出为：
```
ENC(X1Y2Z3A4B5C6D7E8F9G0H1I2J3K4L5M6)
```

### 2. 加密密码 "admin123"

运行工具后选择 `2`，输入 `admin123`，假设输出为：
```
ENC(A1B2C3D4E5F6G7H8I9J0K1L2M3N4O5P6)
```

### 3. 更新配置文件

在 `src/main/resources/application.yml` 中：
```yaml
spring:
  datasource:
    username: ENC(X1Y2Z3A4B5C6D7E8F9G0H1I2J3K4L5M6)
    password: ENC(A1B2C3D4E5F6G7H8I9J0K1L2M3N4O5P6)
```

### 4. 启动应用

应用启动时会自动识别加密格式并解密用户名和密码，无需修改代码。

## 加密其他类型的字符串

### 加密Token或其他敏感信息

加密功能不仅限于数据库用户名和密码，可以加密任何类型的敏感字符串，如：
- API Token
- 第三方服务密钥
- 其他敏感配置项

### 使用方法

#### 方法一：使用加密工具（推荐）

1. **运行加密工具**：
   ```bash
   java -cp target/classes com.huawei.aitransform.util.PasswordEncryptor
   ```

2. **选择选项 3**，输入要加密的字符串（如Token）

3. **将输出的加密字符串复制到配置文件**：
   ```yaml
   # 示例：加密API Token
   api:
     token: ENC(加密后的Token字符串)
   ```

#### 方法二：命令行方式

```bash
java -cp target/classes com.huawei.aitransform.util.PasswordEncryptor token your_token_here
```

#### 方法三：在代码中使用CryptoUtil

如果需要在代码中动态加密/解密，可以直接使用 `CryptoUtil` 工具类：

```java
import com.huawei.aitransform.util.CryptoUtil;

// 加密
String encrypted = CryptoUtil.encrypt("your_token_here");
// 输出格式：Base64编码的密文

// 解密（自动识别ENC格式）
String decrypted = CryptoUtil.decryptIfNeeded("ENC(加密字符串)");
// 或者直接解密Base64密文
String decrypted = CryptoUtil.decrypt("Base64密文");
```

### 在配置文件中使用加密值

在 `application.yml` 中，任何配置项都可以使用 `ENC(...)` 格式：

```yaml
# 示例配置
api:
  token: ENC(加密后的Token)
  secret-key: ENC(加密后的密钥)

third-party:
  access-token: ENC(加密后的访问令牌)
```

### 在代码中读取并解密

如果需要在代码中读取加密的配置项，可以使用 `CryptoUtil.decryptIfNeeded()` 方法：

```java
import com.huawei.aitransform.util.CryptoUtil;
import org.springframework.beans.factory.annotation.Value;

@Value("${api.token}")
private String apiToken;

// 在需要使用的地方解密
public void useToken() {
    String decryptedToken = CryptoUtil.decryptIfNeeded(apiToken);
    // 使用解密后的Token
}
```

**注意**：`decryptIfNeeded()` 方法会自动判断字符串是否为 `ENC(...)` 格式，如果是则解密，否则直接返回原值，因此可以安全地用于所有配置项。

## 技术实现

- **加密算法**: AES-128
- **加密模式**: AES/ECB/PKCS5Padding
- **密钥管理**: 支持环境变量、系统属性、默认密钥三种方式
- **自动解密**: 
  - 数据库用户名和密码：通过 `DataSourceConfig` 在数据源初始化时自动解密
  - 其他配置项：可在代码中使用 `CryptoUtil.decryptIfNeeded()` 方法解密
- **通用性**: `CryptoUtil` 工具类支持加密/解密任何字符串，不仅限于数据库账号密码

## 注意事项

1. **密钥安全**：生产环境务必使用自定义密钥，不要使用默认密钥
2. **密钥一致性**：加密和解密必须使用相同的密钥
3. **备份密钥**：妥善保管加密密钥，丢失密钥将无法解密数据
4. **配置文件安全**：虽然用户名和密码已加密，但仍建议限制配置文件的访问权限
5. **兼容性**：系统同时支持明文和加密格式，可以逐步迁移
6. **用户名和密码**：用户名和密码可以分别选择是否加密，互不影响
7. **通用加密**：加密功能不仅限于数据库账号密码，可以加密任何敏感字符串（Token、密钥等）
8. **代码中使用**：在代码中读取加密配置时，使用 `CryptoUtil.decryptIfNeeded()` 方法自动解密

## 故障排查

### 问题：启动时提示"解密失败"

**可能原因：**
1. 密钥不匹配（加密时使用的密钥与解密时不同）
2. 加密格式错误（不是 `ENC(...)` 格式）
3. 加密字符串被截断或修改

**解决方法：**
1. 确认使用相同的密钥进行加密和解密
2. 检查配置文件中的格式是否正确
3. 重新生成加密密码

### 问题：无法运行加密工具

**解决方法：**
1. 确保已编译项目：`mvn compile`
2. 检查类路径是否正确
3. 使用Maven方式运行：`mvn exec:java -Dexec.mainClass="com.huawei.aitransform.util.PasswordEncryptor"`

## 相关文件

- `src/main/java/com/huawei/aitransform/util/CryptoUtil.java` - 加解密工具类
- `src/main/java/com/huawei/aitransform/util/PasswordEncryptor.java` - 用户名和密码加密工具
- `src/main/java/com/huawei/aitransform/config/DataSourceConfig.java` - 数据源配置（自动解密用户名和密码）
- `src/main/resources/application.yml` - 应用配置文件

