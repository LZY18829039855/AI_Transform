# 数据库信息加密使用说明

## 概述

本项目已集成数据库信息加密功能，支持在配置文件中使用加密格式的数据库密码，避免明文存储敏感信息。

## 加密格式

配置文件中的密码支持以下两种格式：

1. **明文格式**（不推荐）：
   ```yaml
   password: admin123
   ```

2. **加密格式**（推荐）：
   ```yaml
   password: ENC(加密后的密码字符串)
   ```

系统会自动识别 `ENC(...)` 格式，并在启动时自动解密。

## 使用方法

### 方法一：使用密码加密工具（推荐）

1. **编译项目**：
   ```bash
   mvn compile
   ```

2. **运行加密工具**：
   ```bash
   # Windows PowerShell
   java -cp target/classes com.huawei.aitransform.util.PasswordEncryptor
   
   # 或者使用Maven
   mvn exec:java -Dexec.mainClass="com.huawei.aitransform.util.PasswordEncryptor"
   ```

3. **输入要加密的密码**，工具会输出加密后的字符串，格式如：`ENC(xxxxxx)`

4. **将输出的加密字符串复制到 `application.yml`**：
   ```yaml
   password: ENC(xxxxxx)
   ```

### 方法二：命令行参数方式

```bash
java -cp target/classes com.huawei.aitransform.util.PasswordEncryptor your_password
```

工具会直接输出加密后的密码。

## 加密密钥配置

### 默认密钥

如果不设置密钥，系统会使用默认密钥。**生产环境强烈建议使用自定义密钥！**

### 自定义密钥方式

#### 方式一：环境变量（推荐）

**Windows PowerShell:**
```powershell
$env:CRYPTO_KEY="your_custom_key_here"
```

**Windows CMD:**
```cmd
set CRYPTO_KEY=your_custom_key_here
```

**Linux/Mac:**
```bash
export CRYPTO_KEY=your_custom_key_here
```

#### 方式二：Java系统属性

```bash
java -Dcrypto.key=your_custom_key_here -jar your-app.jar
```

#### 方式三：生成新密钥

运行以下代码可以生成一个新的随机密钥：

```java
String key = CryptoUtil.generateKey();
System.out.println(key);
```

**重要提示：**
- 密钥长度建议至少16个字符
- 密钥一旦设置，必须保持一致，否则无法解密已加密的密码
- 建议将密钥保存在安全的地方（如密钥管理服务），不要提交到代码仓库

## 示例

### 1. 加密密码 "admin123"

运行工具后输入 `admin123`，假设输出为：
```
ENC(A1B2C3D4E5F6G7H8I9J0K1L2M3N4O5P6)
```

### 2. 更新配置文件

在 `src/main/resources/application.yml` 中：
```yaml
spring:
  datasource:
    password: ENC(A1B2C3D4E5F6G7H8I9J0K1L2M3N4O5P6)
```

### 3. 启动应用

应用启动时会自动识别加密格式并解密，无需修改代码。

## 技术实现

- **加密算法**: AES-128
- **加密模式**: AES/ECB/PKCS5Padding
- **密钥管理**: 支持环境变量、系统属性、默认密钥三种方式
- **自动解密**: 通过 `DataSourceConfig` 在数据源初始化时自动解密

## 注意事项

1. **密钥安全**：生产环境务必使用自定义密钥，不要使用默认密钥
2. **密钥一致性**：加密和解密必须使用相同的密钥
3. **备份密钥**：妥善保管加密密钥，丢失密钥将无法解密数据
4. **配置文件安全**：虽然密码已加密，但仍建议限制配置文件的访问权限
5. **兼容性**：系统同时支持明文和加密格式，可以逐步迁移

## 故障排查

### 问题：启动时提示"解密失败"

**可能原因：**
1. 密钥不匹配（加密时使用的密钥与解密时不同）
2. 加密格式错误（不是 `ENC(...)` 格式）
3. 加密字符串被截断或修改

**解决方法：**
1. 确认使用相同的密钥进行加密和解密
2. 检查配置文件中的格式是否正确
3. 重新生成加密密码

### 问题：无法运行加密工具

**解决方法：**
1. 确保已编译项目：`mvn compile`
2. 检查类路径是否正确
3. 使用Maven方式运行：`mvn exec:java -Dexec.mainClass="com.huawei.aitransform.util.PasswordEncryptor"`

## 相关文件

- `src/main/java/com/huawei/aitransform/util/CryptoUtil.java` - 加解密工具类
- `src/main/java/com/huawei/aitransform/util/PasswordEncryptor.java` - 密码加密工具
- `src/main/java/com/huawei/aitransform/config/DataSourceConfig.java` - 数据源配置（自动解密）
- `src/main/resources/application.yml` - 应用配置文件

