# 修复方案：任职数据缺失问题

## 问题根源

**关键差异**：

1. **认证数据查询**：
   - 只要求证书状态为有效（`status = 1 OR approved_status = 1`）
   - **没有日期范围限制**
   - 只要证书状态有效，就会返回该员工

2. **任职数据查询**：
   - 要求任职记录必须在当前日期范围内有效
   - 条件：`CURDATE() BETWEEN q.competence_from AND q.competence_to`
   - **如果任职记录已过期，员工会被过滤掉**

**结果**：
- 如果员工的任职记录已过期（例如，有效期是2024年1月1日到2024年12月31日，但当前日期是2025年1月1日）
- 认证数据查询：仍然返回该员工（证书没有过期限制）
- 任职数据查询：不返回该员工（任职记录已过期）
- **导致数据不一致**

## 解决方案

### 方案1：移除日期范围限制（推荐，如果业务允许）

**修改逻辑**：
- 移除 `CURDATE() BETWEEN q.competence_from AND q.competence_to` 条件
- 查询所有任职记录（包括已过期的）
- 与认证数据查询的逻辑保持一致

**优点**：
- 与认证数据查询逻辑一致
- 数据更完整

**缺点**：
- 可能包含已过期的任职记录

### 方案2：查询最近N年内的任职记录

**修改逻辑**：
- 将 `CURDATE() BETWEEN q.competence_from AND q.competence_to` 
- 改为 `q.competence_to >= DATE_SUB(CURDATE(), INTERVAL 2 YEAR)`（例如，查询最近2年内的任职记录）

**优点**：
- 既包含当前有效的记录，也包含最近过期的记录
- 数据更完整，同时避免查询过于久远的数据

**缺点**：
- 仍然可能遗漏更早的任职记录

### 方案3：查询所有任职记录，但优先显示当前有效的

**修改逻辑**：
- 使用 LEFT JOIN 而不是 INNER JOIN
- 在子查询中，优先查询当前有效的任职记录，如果没有则查询最近的任职记录

**优点**：
- 数据最完整
- 可以区分当前有效和已过期的记录

**缺点**：
- 逻辑更复杂

## 推荐方案

**推荐使用方案1**：移除日期范围限制，查询所有任职记录。

**理由**：
1. 与认证数据查询的逻辑保持一致
2. 数据更完整，不会遗漏已过期的任职记录
3. 如果业务需要区分当前有效和已过期的记录，可以在前端或业务层处理

## 修改位置

**文件**：`src/main/resources/mapper/EmployeeMapper.xml`

**方法**：`getEmployeeQualifiedDetailsByDeptLevel`

**需要修改的地方**：
1. 移除主查询中的 `AND CURDATE() BETWEEN q.competence_from AND q.competence_to` 条件
2. 移除子查询中的 `AND CURDATE() BETWEEN q2.competence_from AND q2.competence_to` 条件
3. 或者，将日期条件改为查询最近N年内的记录

## 注意事项

1. **业务需求确认**：在修改前，需要确认业务需求：
   - 是否应该只查询当前有效的任职记录？
   - 还是应该查询所有任职记录（包括已过期的）？

2. **数据一致性**：如果业务需求是只查询当前有效的任职记录，那么：
   - 认证数据查询也应该添加类似的日期限制
   - 或者，需要调整业务逻辑，让两个查询的筛选条件一致

3. **性能影响**：移除日期限制后，查询的数据量可能会增加，需要评估性能影响



