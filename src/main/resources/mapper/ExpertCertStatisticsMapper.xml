<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.huawei.aitransform.mapper.ExpertCertStatisticsMapper">

    <!-- 查询三层组织的专家信息，联表查询证书信息 -->
    <select id="getExpertStatisticsByLevel3" resultType="com.huawei.aitransform.entity.ExpertCertStatisticsVO">
        SELECT 
            e.ai_maturity AS aiMaturity,
            e.job_category AS jobCategory,
            e.employee_number AS employeeNumber,
            CASE 
                WHEN cert.employee_number IS NOT NULL OR cert.w3_account IS NOT NULL THEN 1 
                ELSE 0 
            END AS hasCert
        FROM expert_info e
        LEFT JOIN (
            SELECT DISTINCT 
                COALESCE(employee_number, w3_account) AS employee_number,
                w3_account
            FROM dwr_t_cert_record_t
            WHERE (cer_title LIKE '华为研究类能力认证（专业级，%'
                OR cer_title LIKE '%华为研究类能力认证（专业级，%')
            AND (status = 1 OR approved_status = 1)
        ) cert ON (e.employee_number = cert.employee_number OR e.employee_number = cert.w3_account)
        WHERE e.org_level = #{deptName}
        AND e.on_duty_status = 1
        AND e.employee_number IS NOT NULL
        AND e.employee_number != ''
        ORDER BY e.ai_maturity, e.job_category
    </select>

    <!-- 查询四层组织的专家信息，联表查询证书信息 -->
    <select id="getExpertStatisticsByLevel4" resultType="com.huawei.aitransform.entity.ExpertCertStatisticsVO">
        SELECT 
            e.ai_maturity AS aiMaturity,
            e.job_category AS jobCategory,
            e.employee_number AS employeeNumber,
            CASE 
                WHEN cert.employee_number IS NOT NULL OR cert.w3_account IS NOT NULL THEN 1 
                ELSE 0 
            END AS hasCert
        FROM expert_info e
        LEFT JOIN (
            SELECT DISTINCT 
                COALESCE(employee_number, w3_account) AS employee_number,
                w3_account
            FROM dwr_t_cert_record_t
            WHERE (cer_title LIKE '华为研究类能力认证（专业级，%'
                OR cer_title LIKE '%华为研究类能力认证（专业级，%')
            AND (status = 1 OR approved_status = 1)
        ) cert ON (e.employee_number = cert.employee_number OR e.employee_number = cert.w3_account)
        WHERE e.l4_org_code = #{deptCode}
        AND e.on_duty_status = 1
        AND e.employee_number IS NOT NULL
        AND e.employee_number != ''
        ORDER BY e.ai_maturity, e.job_category
    </select>

    <!-- 查询已通过华为研究类能力认证的专家工号列表 -->
    <select id="getCertifiedEmployeeNumbers" resultType="java.lang.String">
        SELECT DISTINCT c.employee_number
        FROM dwr_t_cert_record_t c
        WHERE c.employee_number IN
        <foreach collection="employeeNumbers" item="empNo" open="(" separator="," close=")">
            #{empNo}
        </foreach>
        AND c.employee_number IS NOT NULL 
        AND c.employee_number != ''
        AND (c.status = 1 OR c.approved_status = 1)
        AND (
            -- 华为研究类能力认证（专业级，xxx）
            c.cer_title = '华为研究类能力认证（专业级，AI算法技术）'
            OR c.cer_title = '华为研究类能力认证（专业级，AI决策推理）'
            OR c.cer_title = '华为研究类能力认证（专业级，AI图像语言语义）'
        )
        UNION
        SELECT DISTINCT c.w3_account
        FROM dwr_t_cert_record_t c
        WHERE c.w3_account IN
        <foreach collection="employeeNumbers" item="empNo" open="(" separator="," close=")">
            #{empNo}
        </foreach>
        AND c.w3_account IS NOT NULL 
        AND c.w3_account != ''
        AND (c.status = 1 OR c.approved_status = 1)
        AND (
            -- 华为研究类能力认证（专业级，xxx）
            c.cer_title = '华为研究类能力认证（专业级，AI算法技术）'
            OR c.cer_title = '华为研究类能力认证（专业级，AI决策推理）'
            OR c.cer_title = '华为研究类能力认证（专业级，AI图像语言语义）'
        )
    </select>

    <!-- 查询获得AI任职的员工工号列表 -->
    <select id="getQualifiedEmployeeNumbers" resultType="java.lang.String">
        SELECT DISTINCT q.employee_number
        FROM t_qualifications q
        WHERE q.employee_number IN
        <foreach collection="employeeNumbers" item="empNo" open="(" separator="," close=")">
            #{empNo}
        </foreach>
        AND q.employee_number IS NOT NULL
        AND q.employee_number != ''
        AND q.direction_cn_name IN (
            '数据科学与AI工程（ICT）',
            'AI算法及应用（ICT）',
            'AI软件工程与工具（ICT）',
            'AI系统测试（ICT）'
        )
        AND q.competence_from IS NOT NULL
        AND q.competence_to IS NOT NULL
        AND CURDATE() BETWEEN q.competence_from AND q.competence_to
    </select>

    <!-- 查询已通过科目二考试的员工工号列表 -->
    <select id="getSubject2PassedEmployeeNumbers" resultType="java.lang.String">
        SELECT DISTINCT exam.emp_num
        FROM t_exam_record exam
        WHERE exam.emp_num IN
        <foreach collection="employeeNumbers" item="empNo" open="(" separator="," close=")">
            #{empNo}
        </foreach>
        AND exam.emp_num IS NOT NULL
        AND exam.emp_num != ''
        AND exam.exam_name IS NOT NULL
        AND exam.exam_name != ''
        AND exam.is_pass = 1
    </select>

    <!-- 根据部门编码、AI成熟度和职位类查询专家认证详细信息 -->
    <select id="getExpertCertDetailsByConditions" resultType="com.huawei.aitransform.entity.EmployeeDetailVO">
        SELECT DISTINCT
            e.cn_name AS name,
            SUBSTRING(e.account, 2) AS employeeNumber,
            e.competence_category AS competenceCategory,
            e.competence_subcategory AS competenceSubcategory,
            e.departname2,
            e.departname3,
            e.departname4,
            e.departname5,
            e.departname6,
            cert.cer_title AS certTitle,
            cert.start_time AS certStartTime,
            CASE 
                WHEN exam.emp_num IS NOT NULL THEN 1 
                ELSE 0 
            END AS isPassedSubject2,
            CASE 
                WHEN c.account IS NOT NULL THEN 1 
                ELSE 0 
            END AS isCadre,
            COALESCE(exp.ai_maturity, '未知') AS aiMaturity,
            NULL AS miniDeptName
        FROM expert_info exp
        INNER JOIN t_employee e ON (exp.employee_number = e.account)
        <choose>
            <when test="queryType != null and queryType == 2">
                <!-- queryType=2: 使用 LEFT JOIN，返回所有人员，即使没有AI专业级证书也显示 -->
                LEFT JOIN (
                    SELECT DISTINCT
                        COALESCE(employee_number, w3_account) AS employee_number,
                        w3_account,
                        cer_title,
                        start_time
                    FROM dwr_t_cert_record_t
                    WHERE (status = 1 OR approved_status = 1)
                    AND (
                        -- 华为研究类能力认证（专业级，xxx）
                        cer_title = '华为研究类能力认证（专业级，AI算法技术）'
                        OR cer_title = '华为研究类能力认证（专业级，AI决策推理）'
                        OR cer_title = '华为研究类能力认证（专业级，AI图像语言语义）'
                    )
                ) cert ON (e.account = cert.employee_number OR e.account = cert.w3_account)
            </when>
            <otherwise>
                <!-- queryType=1: 使用 INNER JOIN，只返回有AI专业级证书的人员 -->
                INNER JOIN (
                    SELECT DISTINCT
                        COALESCE(employee_number, w3_account) AS employee_number,
                        w3_account,
                        cer_title,
                        start_time
                    FROM dwr_t_cert_record_t
                    WHERE (status = 1 OR approved_status = 1)
                    AND (
                        -- 华为研究类能力认证（专业级，xxx）
                        cer_title = '华为研究类能力认证（专业级，AI算法技术）'
                        OR cer_title = '华为研究类能力认证（专业级，AI决策推理）'
                        OR cer_title = '华为研究类能力认证（专业级，AI图像语言语义）'
                    )
                ) cert ON (e.account = cert.employee_number OR e.account = cert.w3_account)
            </otherwise>
        </choose>
        LEFT JOIN (
            SELECT DISTINCT emp_num
            FROM t_exam_record
            WHERE exam_name IS NOT NULL
            AND exam_name != ''
            AND is_pass = 1
            AND emp_num IS NOT NULL
            AND emp_num != ''
        ) exam ON (e.sn = exam.emp_num)
        LEFT JOIN t_cadre c ON (SUBSTRING(e.account, 2) = c.account)
        WHERE e.expired_date IS NULL
        AND exp.on_duty_status = 1
        AND exp.employee_number IS NOT NULL
        AND exp.employee_number != ''
        <choose>
            <when test="deptName != null and deptName != ''">
                AND exp.org_level = #{deptName}
            </when>
            <otherwise>
                AND exp.l4_org_code = #{deptCode}
            </otherwise>
        </choose>
        <if test="aiMaturity != null and aiMaturity != ''">
            <choose>
                <when test="'L5'.equals(aiMaturity)">
                    <!-- 当aiMaturity为L5时，查询L2和L3的数据（L5代表查询L2和L3） -->
                    AND exp.ai_maturity IN ('L2', 'L3')
                </when>
                <otherwise>
                    AND COALESCE(exp.ai_maturity, '未知') = #{aiMaturity}
                </otherwise>
            </choose>
        </if>
        <if test="jobCategory != null and jobCategory != ''">
            AND COALESCE(exp.job_category, '未知') = #{jobCategory}
        </if>
        AND e.account IS NOT NULL
        AND e.account != ''
        AND e.account REGEXP '^[a-z]0[0-9]{7}$'
        ORDER BY e.account
    </select>

    <!-- 根据部门编码、AI成熟度和职位类查询专家任职详细信息 -->
    <select id="getExpertQualifiedDetailsByConditions" resultType="com.huawei.aitransform.entity.EmployeeDetailVO">
        SELECT DISTINCT
            e.cn_name AS name,
            SUBSTRING(e.account, 2) AS employeeNumber,
            e.competence_category AS competenceCategory,
            e.competence_subcategory AS competenceSubcategory,
            e.departname2,
            e.departname3,
            e.departname4,
            e.departname5,
            e.departname6,
            q.competence_family_cn AS competenceFamilyCn,
            q.competence_category_cn AS competenceCategoryCn,
            q.competence_subcategory_cn AS competenceSubcategoryCn,
            q.direction_cn_name AS directionCnName,
            q.competence_rating_cn AS competenceRatingCn,
            q.competence_grade_cn AS competenceGradeCn,
            q.competence_from AS competenceFrom,
            q.competence_to AS competenceTo,
            CASE 
                WHEN c.account IS NOT NULL THEN 1 
                ELSE 0 
            END AS isCadre
        FROM expert_info exp
        INNER JOIN t_employee e ON (exp.employee_number = e.account)
        INNER JOIN t_qualifications q ON (SUBSTRING(e.account, 2) = q.employee_number)
        LEFT JOIN t_cadre c ON (SUBSTRING(e.account, 2) = c.account)
        WHERE e.expired_date IS NULL
        AND exp.on_duty_status = 1
        AND exp.employee_number IS NOT NULL
        AND exp.employee_number != ''
        AND q.employee_number IS NOT NULL
        AND q.employee_number != ''
        AND q.direction_cn_name IN (
            '数据科学与AI工程（ICT）',
            'AI算法及应用（ICT）',
            'AI软件工程与工具（ICT）',
            'AI系统测试（ICT）'
        )
        AND q.competence_from IS NOT NULL
        AND q.competence_to IS NOT NULL
        <choose>
            <when test="deptName != null and deptName != ''">
                AND exp.org_level = #{deptName}
            </when>
            <otherwise>
                AND exp.l4_org_code = #{deptCode}
            </otherwise>
        </choose>
        <if test="aiMaturity != null and aiMaturity != ''">
            AND COALESCE(exp.ai_maturity, '未知') = #{aiMaturity}
        </if>
        <if test="jobCategory != null and jobCategory != ''">
            AND COALESCE(exp.job_category, '未知') = #{jobCategory}
        </if>
        AND e.account IS NOT NULL
        AND e.account != ''
        AND e.account REGEXP '^[a-z]0[0-9]{7}$'
        ORDER BY e.account, q.competence_from
    </select>

</mapper>

