<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.huawei.aitransform.mapper.ExpertCertStatisticsMapper">

    <!-- æŸ¥è¯¢ä¸‰å±‚ç»„ç»‡çš„ä¸“å®¶ä¿¡æ¯ï¼Œè”è¡¨æŸ¥è¯¢è¯ä¹¦ä¿¡æ¯ -->
    <select id="getExpertStatisticsByLevel3" resultType="com.huawei.aitransform.entity.ExpertCertStatisticsVO">
        SELECT 
            e.ai_maturity AS aiMaturity,
            e.job_category AS jobCategory,
            e.employee_number AS employeeNumber,
            CASE 
                WHEN cert.employee_number IS NOT NULL OR cert.w3_account IS NOT NULL THEN 1 
                ELSE 0 
            END AS hasCert
        FROM expert_info e
        LEFT JOIN (
            SELECT DISTINCT 
                COALESCE(employee_number, w3_account) AS employee_number,
                w3_account
            FROM dwr_t_cert_record_t
            WHERE (cer_title LIKE 'åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼Œ%'
                OR cer_title LIKE '%åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼Œ%')
            AND (status = 1 OR approved_status = 1)
        ) cert ON (e.employee_number = cert.employee_number OR e.employee_number = cert.w3_account)
        WHERE e.org_level = #{deptName}
        AND e.on_duty_status = 1
        AND e.employee_number IS NOT NULL
        AND e.employee_number != ''
        ORDER BY e.ai_maturity, e.job_category
    </select>

    <!-- æŸ¥è¯¢å››å±‚ç»„ç»‡çš„ä¸“å®¶ä¿¡æ¯ï¼Œè”è¡¨æŸ¥è¯¢è¯ä¹¦ä¿¡æ¯ -->
    <select id="getExpertStatisticsByLevel4" resultType="com.huawei.aitransform.entity.ExpertCertStatisticsVO">
        SELECT 
            e.ai_maturity AS aiMaturity,
            e.job_category AS jobCategory,
            e.employee_number AS employeeNumber,
            CASE 
                WHEN cert.employee_number IS NOT NULL OR cert.w3_account IS NOT NULL THEN 1 
                ELSE 0 
            END AS hasCert
        FROM expert_info e
        LEFT JOIN (
            SELECT DISTINCT 
                COALESCE(employee_number, w3_account) AS employee_number,
                w3_account
            FROM dwr_t_cert_record_t
            WHERE (cer_title LIKE 'åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼Œ%'
                OR cer_title LIKE '%åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼Œ%')
            AND (status = 1 OR approved_status = 1)
        ) cert ON (e.employee_number = cert.employee_number OR e.employee_number = cert.w3_account)
        WHERE e.l4_org_code = #{deptCode}
        AND e.on_duty_status = 1
        AND e.employee_number IS NOT NULL
        AND e.employee_number != ''
        ORDER BY e.ai_maturity, e.job_category
    </select>

    <!-- æŸ¥è¯¢å·²é€šè¿‡åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯çš„ä¸“å®¶å·¥å·åˆ—è¡¨ -->
    <select id="getCertifiedEmployeeNumbers" resultType="java.lang.String">
        SELECT DISTINCT c.employee_number
        FROM dwr_t_cert_record_t c
        WHERE c.employee_number IN
        <foreach collection="employeeNumbers" item="empNo" open="(" separator="," close=")">
            #{empNo}
        </foreach>
        AND c.employee_number IS NOT NULL 
        AND c.employee_number != ''
        AND (c.status = 1 OR c.approved_status = 1)
        AND (
            -- åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼Œxxxï¼?            c.cer_title = 'åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼ŒAIç®—æ³•æŠ€æœ¯ï¼‰'
            OR c.cer_title = 'åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼ŒAIå†³ç­–æ¨ç†ï¼?
            OR c.cer_title = 'åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼ŒAIå›¾åƒè¯­è¨€è¯­ä¹‰ï¼?
        )
        UNION
        SELECT DISTINCT c.employee_number
        FROM dwr_t_cert_record_t c
        WHERE c.employee_number IN
        <foreach collection="employeeNumbers" item="empNo" open="(" separator="," close=")">
            #{empNo}
        </foreach>
        AND c.employee_number IS NOT NULL 
        AND c.employee_number != ''
        AND (c.status = 1 OR c.approved_status = 1)
        AND (
            -- åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼Œxxxï¼?            c.cer_title = 'åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼ŒAIç®—æ³•æŠ€æœ¯ï¼‰'
            OR c.cer_title = 'åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼ŒAIå†³ç­–æ¨ç†ï¼?
            OR c.cer_title = 'åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼ŒAIå›¾åƒè¯­è¨€è¯­ä¹‰ï¼?
        )
    </select>

    <!-- æŸ¥è¯¢è·å¾—AIä»»èŒçš„å‘˜å·¥å·¥å·åˆ—è¡?-->
    <select id="getQualifiedEmployeeNumbers" resultType="java.lang.String">
        SELECT DISTINCT q.employee_number
        FROM t_qualifications q
        WHERE q.employee_number IN
        <foreach collection="employeeNumbers" item="empNo" open="(" separator="," close=")">
            #{empNo}
        </foreach>
        AND q.employee_number IS NOT NULL
        AND q.employee_number != ''
        AND q.direction_cn_name IN (
            'æ•°æ®ç§‘å­¦ä¸AIå·¥ç¨‹ï¼ˆICTï¼?,
            'AIç®—æ³•åŠåº”ç”¨ï¼ˆICTï¼?,
            'AIè½¯ä»¶å·¥ç¨‹ä¸å·¥å…·ï¼ˆICTï¼?,
            'AIç³»ç»Ÿæµ‹è¯•ï¼ˆICTï¼?
        )
        AND q.competence_from IS NOT NULL
        AND q.competence_to IS NOT NULL
        AND CURDATE() BETWEEN q.competence_from AND q.competence_to
    </select>

    <!-- æŸ¥è¯¢å·²é€šè¿‡ç§‘ç›®äºŒè€ƒè¯•çš„å‘˜å·¥å·¥å·åˆ—è¡?-->
    <select id="getSubject2PassedEmployeeNumbers" resultType="java.lang.String">
        SELECT DISTINCT exam.emp_num
        FROM t_exam_record exam
        WHERE exam.emp_num IN
        <foreach collection="employeeNumbers" item="empNo" open="(" separator="," close=")">
            #{empNo}
        </foreach>
        AND exam.emp_num IS NOT NULL
        AND exam.emp_num != ''
        AND exam.exam_name IS NOT NULL
        AND exam.exam_name != ''
        AND exam.is_pass = 1
    </select>

    <!-- æ ¹æ®éƒ¨é—¨ç¼–ç ã€AIæˆç†Ÿåº¦å’ŒèŒä½ç±»æŸ¥è¯¢ä¸“å®¶è®¤è¯è¯¦ç»†ä¿¡æ?-->
    <select id="getExpertCertDetailsByConditions" resultType="com.huawei.aitransform.entity.EmployeeDetailVO">
        SELECT DISTINCT
            e.last_name AS name,
            e.employee_number AS employeeNumber,
            SUBSTRING_INDEX(e.firstdept, '/', 1) AS departname2,
            SUBSTRING_INDEX(e.seconddept, '/', 1) AS departname3,
            SUBSTRING_INDEX(e.thirddept, '/', 1) AS departname4,
            SUBSTRING_INDEX(e.fourthdept, '/', 1) AS departname5,
            SUBSTRING_INDEX(e.fifthdept, '/', 1) AS departname6,
            cert.cer_title AS certTitle,
            cert.start_time AS certStartTime,
            CASE 
                WHEN exam.emp_num IS NOT NULL THEN 1 
                ELSE 0 
            END AS isPassedSubject2,
            CASE 
                WHEN c.account IS NOT NULL THEN 1 
                ELSE 0 
            END AS isCadre,
            COALESCE(c.is_cert_standard, 0) AS isCertStandard,
            COALESCE(exp.ai_maturity, 'æœªçŸ¥') AS aiMaturity,
            NULL AS miniDeptName
        FROM expert_info exp
        INNER JOIN t_employee_sync e ON (exp.employee_number = e.employee_number)
        <choose>
            <when test="queryType != null and queryType == 2">
                <!-- queryType=2: ä½¿ç”¨ LEFT JOINï¼Œè¿”å›æ‰€æœ‰äººå‘˜ï¼Œå³ä½¿æ²¡æœ‰AIä¸“ä¸šçº§è¯ä¹¦ä¹Ÿæ˜¾ç¤º -->
                LEFT JOIN (
                    SELECT DISTINCT
                        COALESCE(employee_number, w3_account) AS employee_number,
                        w3_account,
                        cer_title,
                        start_time
                    FROM dwr_t_cert_record_t
                    WHERE (status = 1 OR approved_status = 1)
                    AND (
                        -- åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼Œxxxï¼?                        cer_title = 'åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼ŒAIç®—æ³•æŠ€æœ¯ï¼‰'
                        OR cer_title = 'åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼ŒAIå†³ç­–æ¨ç†ï¼?
                        OR cer_title = 'åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼ŒAIå›¾åƒè¯­è¨€è¯­ä¹‰ï¼?
                    )
                ) cert ON (e.employee_number = cert.employee_number OR e.employee_number = cert.w3_account)
            </when>
            <otherwise>
                <!-- queryType=1: ä½¿ç”¨ INNER JOINï¼Œåªè¿”å›æœ‰AIä¸“ä¸šçº§è¯ä¹¦çš„äººå‘˜ -->
                INNER JOIN (
                    SELECT DISTINCT
                        COALESCE(employee_number, w3_account) AS employee_number,
                        w3_account,
                        cer_title,
                        start_time
                    FROM dwr_t_cert_record_t
                    WHERE (status = 1 OR approved_status = 1)
                    AND (
                        -- åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼Œxxxï¼?                        cer_title = 'åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼ŒAIç®—æ³•æŠ€æœ¯ï¼‰'
                        OR cer_title = 'åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼ŒAIå†³ç­–æ¨ç†ï¼?
                        OR cer_title = 'åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼ŒAIå›¾åƒè¯­è¨€è¯­ä¹‰ï¼?
                    )
                ) cert ON (e.employee_number = cert.employee_number OR e.employee_number = cert.w3_account)
            </otherwise>
        </choose>
        LEFT JOIN (
            SELECT DISTINCT emp_num
            FROM t_exam_record
            WHERE exam_name IS NOT NULL
            AND exam_name != ''
            AND is_pass = 1
            AND emp_num IS NOT NULL
            AND emp_num != ''
        ) exam ON (e.employee_number = exam.emp_num)
        LEFT JOIN t_cadre c ON (e.employee_number = c.account)
        WHERE e.period_id = 20251126
        AND exp.on_duty_status = 1
        AND exp.employee_number IS NOT NULL
        AND exp.employee_number != ''
        <choose>
            <when test="deptName != null and deptName != ''">
                AND exp.org_level = #{deptName}
            </when>
            <otherwise>
                AND exp.l4_org_code = #{deptCode}
            </otherwise>
        </choose>
        <if test="aiMaturity != null and aiMaturity != ''">
            <choose>
                <when test="'L5'.equals(aiMaturity)">
                    <!-- å½“aiMaturityä¸ºL5æ—¶ï¼ŒæŸ¥è¯¢L2å’ŒL3çš„æ•°æ®ï¼ˆL5ä»£è¡¨æŸ¥è¯¢L2å’ŒL3ï¼?-->
                    AND exp.ai_maturity IN ('L2', 'L3')
                </when>
                <otherwise>
                    AND COALESCE(exp.ai_maturity, 'æœªçŸ¥') = #{aiMaturity}
                </otherwise>
            </choose>
        </if>
        <if test="jobCategory != null and jobCategory != ''">
            <choose>
                <when test="jobCategory == 'å…¶ä»–ç±?">
                    <!-- å…¶ä»–ç±»ï¼šæŸ¥è¯¢æ‰€æœ‰ä¸æ˜?ç ”ç©¶ç±?ã€?è½¯ä»¶ç±?ã€?ç³»ç»Ÿç±?ã€?æµ‹è¯•ç±?çš„èŒä½ç±» -->
                    AND COALESCE(exp.job_category, 'æœªçŸ¥') NOT IN ('ç ”ç©¶ç±?, 'è½¯ä»¶ç±?, 'ç³»ç»Ÿç±?, 'æµ‹è¯•ç±?)
                </when>
                <otherwise>
                    <!-- å…¶ä»–èŒä½ç±»ï¼šç²¾ç¡®åŒ¹é… -->
                    AND COALESCE(exp.job_category, 'æœªçŸ¥') = #{jobCategory}
                </otherwise>
            </choose>
        </if>
        AND e.employee_number IS NOT NULL
        AND e.employee_number != ''
        ORDER BY e.employee_number
    </select>

    <!-- æ ¹æ®éƒ¨é—¨ç¼–ç ã€AIæˆç†Ÿåº¦å’ŒèŒä½ç±»æŸ¥è¯¢ä¸“å®¶ä»»èŒè¯¦ç»†ä¿¡æ?-->
    <select id="getExpertQualifiedDetailsByConditions" resultType="com.huawei.aitransform.entity.EmployeeDetailVO">
        SELECT DISTINCT
            e.last_name AS name,
            e.employee_number AS employeeNumber,
            CASE 
                WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(e.job_category, '-', 2), '-', -1)
                WHEN e.job_category LIKE '%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                ELSE e.job_category
            END AS competenceCategory,
            SUBSTRING_INDEX(e.firstdept, '/', 1) AS departname2,
            SUBSTRING_INDEX(e.seconddept, '/', 1) AS departname3,
            SUBSTRING_INDEX(e.thirddept, '/', 1) AS departname4,
            SUBSTRING_INDEX(e.fourthdept, '/', 1) AS departname5,
            SUBSTRING_INDEX(e.fifthdept, '/', 1) AS departname6,
            SUBSTRING_INDEX(e.sixthdept, '/', 1) AS departname7,
            q.competence_family_cn AS competenceFamilyCn,
            q.competence_category_cn AS competenceCategoryCn,
            q.competence_subcategory_cn AS competenceSubcategoryCn,
            q.direction_cn_name AS directionCnName,
            q.competence_rating_cn AS competenceRatingCn,
            q.competence_grade_cn AS competenceGradeCn,
            q.competence_from AS competenceFrom,
            q.competence_to AS competenceTo,
            COALESCE(exp.position_ai_maturity, 'æœªçŸ¥') AS aiMaturity,
            CASE 
                WHEN c.account IS NOT NULL THEN 1 
                ELSE 0 
            END AS isCadre,
            c.cadre_type AS cadreType,
            SUBSTRING_INDEX(dept.dept_name, '/', 1) AS miniDeptName,
            COALESCE(exp.is_qualifications_standard, 0) AS isQualificationsStandard
        FROM t_expert exp
        INNER JOIN t_employee_sync e ON (exp.account = e.employee_number)
        LEFT JOIN t_qualifications q ON (
            e.employee_number = q.employee_number
            AND q.employee_number IS NOT NULL
            AND q.employee_number != ''
            AND q.direction_cn_name IN (
                'æ•°æ®ç§‘å­¦ä¸AIå·¥ç¨‹ï¼ˆICTï¼?,
                'AIç®—æ³•åŠåº”ç”¨ï¼ˆICTï¼?,
                'AIè½¯ä»¶å·¥ç¨‹ä¸å·¥å…·ï¼ˆICTï¼?,
                'AIç³»ç»Ÿæµ‹è¯•ï¼ˆICTï¼?
            )
            AND q.competence_from IS NOT NULL
            AND q.competence_to IS NOT NULL
            AND CURDATE() BETWEEN q.competence_from AND q.competence_to
            AND q.competence_from = (
                -- å­æŸ¥è¯¢ï¼šæ‰¾åˆ°æ¯ä¸ªå‘˜å·¥æœ€é«˜çº§åˆ«çš„AIä»»èŒè®°å½•çš„competence_from
                SELECT q2.competence_from
                FROM t_qualifications q2
                WHERE q2.employee_number = e.employee_number
                AND q2.employee_number IS NOT NULL
                AND q2.employee_number != ''
                AND q2.direction_cn_name IN (
                    'æ•°æ®ç§‘å­¦ä¸AIå·¥ç¨‹ï¼ˆICTï¼?,
                    'AIç®—æ³•åŠåº”ç”¨ï¼ˆICTï¼?,
                    'AIè½¯ä»¶å·¥ç¨‹ä¸å·¥å…·ï¼ˆICTï¼?,
                    'AIç³»ç»Ÿæµ‹è¯•ï¼ˆICTï¼?
                )
                AND q2.competence_from IS NOT NULL
                AND q2.competence_to IS NOT NULL
                AND CURDATE() BETWEEN q2.competence_from AND q2.competence_to
                ORDER BY 
                    CASE 
                        -- 8çº§æœ€é«˜ï¼Œä¾æ¬¡åˆ?çº§ï¼Œåˆçº§æœ€ä½?                        WHEN q2.competence_rating_cn = '8çº? THEN 1
                        WHEN q2.competence_rating_cn = '7çº? THEN 2
                        WHEN q2.competence_rating_cn = '6çº? THEN 3
                        WHEN q2.competence_rating_cn = '5çº? THEN 4
                        WHEN q2.competence_rating_cn = '4çº? THEN 5
                        WHEN q2.competence_rating_cn = '3çº? THEN 6
                        WHEN q2.competence_rating_cn = '2çº? THEN 7
                        WHEN q2.competence_rating_cn = '1çº? THEN 8
                        WHEN q2.competence_rating_cn = 'åˆçº§' THEN 9
                        ELSE 10
                    END,
                    q2.competence_from DESC
                LIMIT 1
            )
        )
        LEFT JOIN t_cadre c ON (e.employee_number = c.account)
        LEFT JOIN department_info_hrms dept ON (e.sixthdeptcode = dept.dept_code AND DATE(dept.update_time) = '2025-11-18')
        WHERE e.period_id = 20251126
        AND exp.position_ai_maturity IN ('L2', 'L3')
        AND exp.account IS NOT NULL
        AND exp.account != ''
        AND e.employee_number IS NOT NULL
        AND e.employee_number != ''
        <if test="deptCode != null and deptCode != ''">
            <choose>
                <!-- æ ¹æ®éƒ¨é—¨å±‚çº§ä½¿ç”¨å¯¹åº”çš„éƒ¨é—¨å­—æ®µè¿›è¡Œè¿‡æ»¤ï¼Œå‚è€ƒgetExpertInfoByDeptCodeçš„é€»è¾‘ -->
                <when test="deptLevel == 1">
                    AND e.firstdeptcode = #{deptCode}
                </when>
                <when test="deptLevel == 2">
                    AND e.seconddeptcode = #{deptCode}
                </when>
                <when test="deptLevel == 3">
                    AND e.thirddeptcode = #{deptCode}
                </when>
                <when test="deptLevel == 4">
                    AND e.fourthdeptcode = #{deptCode}
                </when>
                <when test="deptLevel == 5">
                    AND e.fifthdeptcode = #{deptCode}
                </when>
                <when test="deptLevel == 6">
                    AND e.sixthdeptcode = #{deptCode}
                </when>
                <when test="deptLevel == 7">
                    <!-- å¦‚æœdeptLevelä¸?ï¼Œå·²ç»æ˜¯æœ€é«˜å±‚çº§ï¼Œæ— æ³•å†æŸ¥è¯?-->
                    AND 1 = 0
                </when>
                <otherwise>
                    <!-- å¦‚æœæ²¡æœ‰æä¾›deptLevelï¼Œä½¿ç”¨æ—§çš„é€»è¾‘ï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰ -->
                    <choose>
                        <when test="deptName != null and deptName != ''">
                            AND e.firstdept = #{deptName}
                        </when>
                        <otherwise>
                            AND e.firstdeptcode = #{deptCode}
                        </otherwise>
                    </choose>
                </otherwise>
            </choose>
        </if>
        <if test="aiMaturity != null and aiMaturity != ''">
            <choose>
                <when test="aiMaturity == 'L5'">
                    AND exp.position_ai_maturity IN ('L2', 'L3')
                </when>
                <otherwise>
                    AND exp.position_ai_maturity = #{aiMaturity}
                </otherwise>
            </choose>
        </if>
        <if test="jobCategory != null and jobCategory != ''">
            <choose>
                <when test="jobCategory == 'éè½¯ä»¶ç±»'">
                    <!-- éè½¯ä»¶ç±»ï¼šæŸ¥è¯¢æ‰€æœ‰ä¸æ˜?è½¯ä»¶ç±?çš„èŒä½ç±» -->
                    AND (
                        CASE 
                            WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(e.job_category, '-', 2), '-', -1)
                            WHEN e.job_category LIKE '%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                            ELSE e.job_category
                        END
                    ) != 'è½¯ä»¶ç±?
                </when>
                <otherwise>
                    <!-- å…¶ä»–èŒä½ç±»ï¼šç²¾ç¡®åŒ¹é… -->
                    AND (
                        CASE 
                            WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(e.job_category, '-', 2), '-', -1)
                            WHEN e.job_category LIKE '%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                            ELSE e.job_category
                        END
                    ) = #{jobCategory}
                </otherwise>
            </choose>
        </if>
        AND e.employee_number IS NOT NULL
        AND e.employee_number != ''
        ORDER BY e.employee_number, COALESCE(q.competence_from, '1900-01-01')
    </select>

    <!-- æ ¹æ®å·¥å·åˆ—è¡¨æŸ¥è¯¢ä¸“å®¶è®¤è¯è¯¦ç»†ä¿¡æ¯ -->
    <select id="getExpertCertDetailsByEmployeeNumbers" resultType="com.huawei.aitransform.entity.EmployeeDetailVO">
        SELECT DISTINCT
            e.last_name AS name,
            e.employee_number AS employeeNumber,
            CASE 
                WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(e.job_category, '-', 2), '-', -1)
                WHEN e.job_category LIKE '%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                ELSE e.job_category
            END AS competenceCategory,
            CASE 
                WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                ELSE NULL
            END AS competenceSubcategory,
            SUBSTRING_INDEX(e.firstdept, '/', 1) AS departname2,
            SUBSTRING_INDEX(e.seconddept, '/', 1) AS departname3,
            SUBSTRING_INDEX(e.thirddept, '/', 1) AS departname4,
            SUBSTRING_INDEX(e.fourthdept, '/', 1) AS departname5,
            SUBSTRING_INDEX(e.fifthdept, '/', 1) AS departname6,
            cert.cer_title AS certTitle,
            cert.start_time AS certStartTime,
            CASE 
                WHEN exam.emp_num IS NOT NULL THEN 1 
                ELSE 0 
            END AS isPassedSubject2,
            CASE 
                WHEN c.account IS NOT NULL THEN 1 
                ELSE 0 
            END AS isCadre,
            COALESCE(exp.is_cert_standard, 0) AS isCertStandard,
            COALESCE(exp.position_ai_maturity, 'æœªçŸ¥') AS aiMaturity,
            NULL AS miniDeptName
        FROM t_expert exp
        INNER JOIN t_employee_sync e ON (exp.account = e.employee_number)
        <choose>
            <when test="queryType != null and queryType == 2">
                <!-- queryType=2: ä½¿ç”¨ LEFT JOINï¼Œè¿”å›æ‰€æœ‰äººå‘˜ï¼Œå³ä½¿æ²¡æœ‰AIä¸“ä¸šçº§è¯ä¹¦ä¹Ÿæ˜¾ç¤º -->
                LEFT JOIN (
                    SELECT DISTINCT
                        COALESCE(employee_number, w3_account) AS employee_number,
                        w3_account,
                        cer_title,
                        start_time
                    FROM dwr_t_cert_record_t
                    WHERE (status = 1 OR approved_status = 1)
                    AND (
                        -- åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼Œxxxï¼?                        cer_title = 'åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼ŒAIç®—æ³•æŠ€æœ¯ï¼‰'
                        OR cer_title = 'åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼ŒAIå†³ç­–æ¨ç†ï¼?
                        OR cer_title = 'åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼ŒAIå›¾åƒè¯­è¨€è¯­ä¹‰ï¼?
                    )
                ) cert ON (e.employee_number = cert.employee_number OR e.employee_number = cert.w3_account)
            </when>
            <otherwise>
                <!-- queryType=1: ä½¿ç”¨ INNER JOINï¼Œåªè¿”å›æœ‰AIä¸“ä¸šçº§è¯ä¹¦çš„äººå‘˜ -->
                INNER JOIN (
                    SELECT DISTINCT
                        COALESCE(employee_number, w3_account) AS employee_number,
                        w3_account,
                        cer_title,
                        start_time
                    FROM dwr_t_cert_record_t
                    WHERE (status = 1 OR approved_status = 1)
                    AND (
                        -- åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼Œxxxï¼?                        cer_title = 'åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼ŒAIç®—æ³•æŠ€æœ¯ï¼‰'
                        OR cer_title = 'åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼ŒAIå†³ç­–æ¨ç†ï¼?
                        OR cer_title = 'åä¸ºç ”ç©¶ç±»èƒ½åŠ›è®¤è¯ï¼ˆä¸“ä¸šçº§ï¼ŒAIå›¾åƒè¯­è¨€è¯­ä¹‰ï¼?
                    )
                ) cert ON (e.employee_number = cert.employee_number OR e.employee_number = cert.w3_account)
            </otherwise>
        </choose>
        LEFT JOIN (
            SELECT DISTINCT emp_num
            FROM t_exam_record
            WHERE exam_name IS NOT NULL
            AND exam_name != ''
            AND is_pass = 1
            AND emp_num IS NOT NULL
            AND emp_num != ''
        ) exam ON (e.employee_number = exam.emp_num)
        LEFT JOIN t_cadre c ON (e.employee_number = c.account)
        WHERE e.period_id = 20251126
        AND exp.position_ai_maturity IN ('L2', 'L3')
        AND exp.account IS NOT NULL
        AND exp.account != ''
        AND e.employee_number IS NOT NULL
        AND e.employee_number != ''
        <if test="employeeNumbers != null and employeeNumbers.size() > 0">
            AND e.employee_number IN
            <foreach collection="employeeNumbers" item="empNum" open="(" separator="," close=")">
                #{empNum}
            </foreach>
        </if>
        <if test="aiMaturity != null and aiMaturity != ''">
            <choose>
                <when test="'L5'.equals(aiMaturity)">
                    <!-- å½“aiMaturityä¸ºL5æ—¶ï¼ŒæŸ¥è¯¢L2å’ŒL3çš„æ•°æ®ï¼ˆL5ä»£è¡¨æŸ¥è¯¢L2å’ŒL3ï¼?-->
                    AND exp.position_ai_maturity IN ('L2', 'L3')
                </when>
                <otherwise>
                    AND COALESCE(exp.position_ai_maturity, 'æœªçŸ¥') = #{aiMaturity}
                </otherwise>
            </choose>
        </if>
        <if test="jobCategory != null and jobCategory != ''">
            <choose>
                <when test="jobCategory == 'å…¶ä»–ç±?">
                    <!-- å…¶ä»–ç±»ï¼šæŸ¥è¯¢æ‰€æœ‰ä¸æ˜?ç ”ç©¶ç±?ã€?è½¯ä»¶ç±?ã€?ç³»ç»Ÿç±?ã€?æµ‹è¯•ç±?çš„èŒä½ç±» -->
                    AND (
                        CASE 
                            WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(e.job_category, '-', 2), '-', -1)
                            WHEN e.job_category LIKE '%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                            ELSE e.job_category
                        END
                    ) NOT IN ('ç ”ç©¶ç±?, 'è½¯ä»¶ç±?, 'ç³»ç»Ÿç±?, 'æµ‹è¯•ç±?)
                </when>
                <otherwise>
                    <!-- å…¶ä»–èŒä½ç±»ï¼šä»job_categoryå­—æ®µä¸­æå–ä¸­é—´éƒ¨åˆ†è¿›è¡ŒåŒ¹é…?-->
                    AND (
                        e.job_category LIKE CONCAT('%-', #{jobCategory}, '-%')
                        OR e.job_category LIKE CONCAT(#{jobCategory}, '-%')
                        OR e.job_category = #{jobCategory}
                    )
                </otherwise>
            </choose>
        </if>
        ORDER BY e.employee_number
    </select>

</mapper>

