<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.huawei.aitransform.mapper.EmployeeMapper">

    <!-- Ê†πÊçÆÈÉ®Èó®Â±ÇÁ∫ßÂíåÈÉ®Èó®IDÂàóË°®Êü•ËØ¢ÂëòÂ∑•Â∑•Âè∑ÂàóË°® -->
    <!-- Ê≥®ÊÑèÔºöÊü•ËØ¢ÁöÑÈÉ®Èó®Â±ÇÁ∫ß‰∏∫‰º†ÂÖ•ÁöÑdeptLevel+1ÔºåÂç≥deptLevel=1Êó∂Êü•ËØ¢firstdeptcode -->
    <select id="getEmployeeNumbersByDeptLevel" resultType="java.lang.String">
        SELECT DISTINCT employee_number
        FROM t_employee_sync
        WHERE period_id = 20251126
        <choose>
            <when test="deptLevel == 1">
                AND firstdeptcode IN
                <foreach collection="deptIds" item="deptId" open="(" separator="," close=")">
                    #{deptId}
                </foreach>
            </when>
            <when test="deptLevel == 2">
                AND seconddeptcode IN
                <foreach collection="deptIds" item="deptId" open="(" separator="," close=")">
                    #{deptId}
                </foreach>
            </when>
            <when test="deptLevel == 3">
                AND thirddeptcode IN
                <foreach collection="deptIds" item="deptId" open="(" separator="," close=")">
                    #{deptId}
                </foreach>
            </when>
            <when test="deptLevel == 4">
                AND fourthdeptcode IN
                <foreach collection="deptIds" item="deptId" open="(" separator="," close=")">
                    #{deptId}
                </foreach>
            </when>
            <when test="deptLevel == 5">
                AND fifthdeptcode IN
                <foreach collection="deptIds" item="deptId" open="(" separator="," close=")">
                    #{deptId}
                </foreach>
            </when>
            <when test="deptLevel == 6">
                AND sixthdeptcode IN
                <foreach collection="deptIds" item="deptId" open="(" separator="," close=")">
                    #{deptId}
                </foreach>
            </when>
            <when test="deptLevel == 7">
                <!-- Â¶ÇÊûúdeptLevel‰∏?ÔºåÂ∑≤ÁªèÊòØÊúÄÈ´òÂ±ÇÁ∫ßÔºåÊó†Ê≥ïÂÜçÊü•ËØ¢‰∏ã‰∏ÄÂ±?-->
                AND 1 = 0
            </when>
        </choose>
        AND employee_number IS NOT NULL
        AND employee_number != ''
    </select>

    <!-- Ê†πÊçÆÈÉ®Èó®Â±ÇÁ∫ßÂíåÈÉ®Èó®IDÂàóË°®Êü•ËØ¢ÂëòÂ∑•Â∑•Âè∑ÂíåËÅå‰ΩçÁ±ª -->
    <!-- Ê≥®ÊÑèÔºöÊü•ËØ¢ÁöÑÈÉ®Èó®Â±ÇÁ∫ß‰∏∫‰º†ÂÖ•ÁöÑdeptLevel+1ÔºåÂç≥deptLevel=1Êó∂Êü•ËØ¢firstdeptcode -->
    <select id="getEmployeesWithCategoryByDeptLevel" resultType="com.huawei.aitransform.entity.EmployeeWithCategoryVO">
        SELECT DISTINCT 
            employee_number AS employeeNumber
        FROM t_employee_sync
        WHERE period_id = 20251126
        <choose>
            <when test="deptLevel == 1">
                AND firstdeptcode IN
                <foreach collection="deptIds" item="deptId" open="(" separator="," close=")">
                    #{deptId}
                </foreach>
            </when>
            <when test="deptLevel == 2">
                AND seconddeptcode IN
                <foreach collection="deptIds" item="deptId" open="(" separator="," close=")">
                    #{deptId}
                </foreach>
            </when>
            <when test="deptLevel == 3">
                AND thirddeptcode IN
                <foreach collection="deptIds" item="deptId" open="(" separator="," close=")">
                    #{deptId}
                </foreach>
            </when>
            <when test="deptLevel == 4">
                AND fourthdeptcode IN
                <foreach collection="deptIds" item="deptId" open="(" separator="," close=")">
                    #{deptId}
                </foreach>
            </when>
            <when test="deptLevel == 5">
                AND fifthdeptcode IN
                <foreach collection="deptIds" item="deptId" open="(" separator="," close=")">
                    #{deptId}
                </foreach>
            </when>
            <when test="deptLevel == 6">
                AND sixthdeptcode IN
                <foreach collection="deptIds" item="deptId" open="(" separator="," close=")">
                    #{deptId}
                </foreach>
            </when>
            <when test="deptLevel == 7">
                <!-- Â¶ÇÊûúdeptLevel‰∏?ÔºåÂ∑≤ÁªèÊòØÊúÄÈ´òÂ±ÇÁ∫ßÔºåÊó†Ê≥ïÂÜçÊü•ËØ¢‰∏ã‰∏ÄÂ±?-->
                AND 1 = 0
            </when>
        </choose>
        AND employee_number IS NOT NULL
        AND employee_number != ''
    </select>

    <!-- Ê†πÊçÆÈÉ®Èó®Â±ÇÁ∫ßÂíåÈÉ®Èó®IDÊü•ËØ¢ÂëòÂ∑•ËÆ§ËØÅËØ¶ÁªÜ‰ø°ÊÅØÔºàÂÖ®ÂëòÁ±ªÂûãÔºâ -->
    <!-- Ê≥®ÊÑèÔºöÂΩìÈÉ®Èó®ID‰∏ç‰∏∫0Êó∂ÔºåÂè™Êü•ËØ¢ÂΩìÂâçÈÉ®Èó®Ôºå‰∏çÊü•ËØ¢Â≠êÈÉ®Èó® -->
    <select id="getEmployeeCertDetailsByDeptLevel" resultType="com.huawei.aitransform.entity.EmployeeDetailVO">
        SELECT DISTINCT
            e.last_name AS name,
            e.employee_number AS employeeNumber,
            CASE 
                WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(e.job_category, '-', 2), '-', -1)
                WHEN e.job_category LIKE '%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                ELSE e.job_category
            END AS competenceCategory,
            CASE 
                WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                ELSE NULL
            END AS competenceSubcategory,
            SUBSTRING_INDEX(e.firstdept, '/', 1) AS departname2,
            SUBSTRING_INDEX(e.seconddept, '/', 1) AS departname3,
            SUBSTRING_INDEX(e.thirddept, '/', 1) AS departname4,
            SUBSTRING_INDEX(e.fourthdept, '/', 1) AS departname5,
            SUBSTRING_INDEX(e.fifthdept, '/', 1) AS departname6,
            SUBSTRING_INDEX(e.sixthdept, '/', 1) AS departname7,
            cert.cer_title AS certTitle,
            cert.start_time AS certStartTime,
            CASE 
                WHEN exam.emp_num IS NOT NULL THEN 1 
                ELSE 0 
            END AS isPassedSubject2,
            CASE 
                WHEN c.account IS NOT NULL THEN 1 
                ELSE 0 
            END AS isCadre,
            c.cadre_type AS cadreType,
            COALESCE(c.is_cert_standard, 0) AS isCertStandard,
            CASE 
                WHEN exp.account IS NOT NULL THEN 1 
                ELSE 0 
            END AS isExpert,
            COALESCE(exp.position_ai_maturity, c.position_ai_maturity, NULL) AS aiMaturity,
            SUBSTRING_INDEX(dept.dept_name, '/', 1) AS miniDeptName,
            NULL AS isQualificationsStandard
        FROM t_employee_sync e
        <choose>
            <when test="queryType != null and queryType == 2">
                <!-- queryType=2: ‰ΩøÁî® LEFT JOINÔºåËøîÂõûÊâÄÊúâ‰∫∫ÂëòÔºåÂç≥‰ΩøÊ≤°ÊúâAI‰∏ì‰∏öÁ∫ßËØÅ‰π¶‰πüÊòæÁ§∫ -->
                LEFT JOIN (
                    SELECT c1.employee_number, c1.w3_account, c1.cer_title, c1.start_time
                    FROM dwr_t_cert_record_t c1
                    INNER JOIN (
                        SELECT 
                            COALESCE(employee_number, w3_account) AS emp_key,
                            MAX(start_time) AS max_start_time
                        FROM dwr_t_cert_record_t
                        WHERE (status = 1 OR approved_status = 1)
                        AND (
                            cer_title = 'Âçé‰∏∫Á†îÁ©∂Á±ªËÉΩÂäõËÆ§ËØÅÔºà‰∏ì‰∏öÁ∫ßÔºåAIÁÆóÊ≥ïÊäÄÊúØÔºâ'
                            OR cer_title = 'Âçé‰∏∫Á†îÁ©∂Á±ªËÉΩÂäõËÆ§ËØÅÔºà‰∏ì‰∏öÁ∫ßÔºåAIÂÜ≥Á≠ñÊé®ÁêÜÔº?
                            OR cer_title = 'Âçé‰∏∫Á†îÁ©∂Á±ªËÉΩÂäõËÆ§ËØÅÔºà‰∏ì‰∏öÁ∫ßÔºåAIÂõæÂÉèËØ≠Ë®ÄËØ≠‰πâÔº?
                        )
                        GROUP BY COALESCE(employee_number, w3_account)
                    ) c2 ON (
                        COALESCE(c1.employee_number, c1.w3_account) = c2.emp_key
                        AND c1.start_time = c2.max_start_time
                    )
                    WHERE (c1.status = 1 OR c1.approved_status = 1)
                    AND (
                        c1.cer_title = 'Âçé‰∏∫Á†îÁ©∂Á±ªËÉΩÂäõËÆ§ËØÅÔºà‰∏ì‰∏öÁ∫ßÔºåAIÁÆóÊ≥ïÊäÄÊúØÔºâ'
                        OR c1.cer_title = 'Âçé‰∏∫Á†îÁ©∂Á±ªËÉΩÂäõËÆ§ËØÅÔºà‰∏ì‰∏öÁ∫ßÔºåAIÂÜ≥Á≠ñÊé®ÁêÜÔº?
                        OR c1.cer_title = 'Âçé‰∏∫Á†îÁ©∂Á±ªËÉΩÂäõËÆ§ËØÅÔºà‰∏ì‰∏öÁ∫ßÔºåAIÂõæÂÉèËØ≠Ë®ÄËØ≠‰πâÔº?
                    )
                ) cert ON (
                    (e.employee_number = cert.employee_number OR e.employee_number = cert.w3_account)
                )
            </when>
            <otherwise>
                <!-- queryType=1: ‰ΩøÁî® INNER JOINÔºåÂè™ËøîÂõûÊúâAI‰∏ì‰∏öÁ∫ßËØÅ‰π¶ÁöÑ‰∫∫Âëò -->
                INNER JOIN (
                    SELECT c1.employee_number, c1.w3_account, c1.cer_title, c1.start_time
                    FROM dwr_t_cert_record_t c1
                    INNER JOIN (
                        SELECT 
                            COALESCE(employee_number, w3_account) AS emp_key,
                            MAX(start_time) AS max_start_time
                        FROM dwr_t_cert_record_t
                        WHERE (status = 1 OR approved_status = 1)
                        AND (
                            cer_title = 'Âçé‰∏∫Á†îÁ©∂Á±ªËÉΩÂäõËÆ§ËØÅÔºà‰∏ì‰∏öÁ∫ßÔºåAIÁÆóÊ≥ïÊäÄÊúØÔºâ'
                            OR cer_title = 'Âçé‰∏∫Á†îÁ©∂Á±ªËÉΩÂäõËÆ§ËØÅÔºà‰∏ì‰∏öÁ∫ßÔºåAIÂÜ≥Á≠ñÊé®ÁêÜÔº?
                            OR cer_title = 'Âçé‰∏∫Á†îÁ©∂Á±ªËÉΩÂäõËÆ§ËØÅÔºà‰∏ì‰∏öÁ∫ßÔºåAIÂõæÂÉèËØ≠Ë®ÄËØ≠‰πâÔº?
                        )
                        GROUP BY COALESCE(employee_number, w3_account)
                    ) c2 ON (
                        COALESCE(c1.employee_number, c1.w3_account) = c2.emp_key
                        AND c1.start_time = c2.max_start_time
                    )
                    WHERE (c1.status = 1 OR c1.approved_status = 1)
                    AND (
                        c1.cer_title = 'Âçé‰∏∫Á†îÁ©∂Á±ªËÉΩÂäõËÆ§ËØÅÔºà‰∏ì‰∏öÁ∫ßÔºåAIÁÆóÊ≥ïÊäÄÊúØÔºâ'
                        OR c1.cer_title = 'Âçé‰∏∫Á†îÁ©∂Á±ªËÉΩÂäõËÆ§ËØÅÔºà‰∏ì‰∏öÁ∫ßÔºåAIÂÜ≥Á≠ñÊé®ÁêÜÔº?
                        OR c1.cer_title = 'Âçé‰∏∫Á†îÁ©∂Á±ªËÉΩÂäõËÆ§ËØÅÔºà‰∏ì‰∏öÁ∫ßÔºåAIÂõæÂÉèËØ≠Ë®ÄËØ≠‰πâÔº?
                    )
                ) cert ON (
                    (e.employee_number = cert.employee_number OR e.employee_number = cert.w3_account)
                )
            </otherwise>
        </choose>
        LEFT JOIN (
            SELECT DISTINCT emp_num
            FROM t_exam_record
            WHERE exam_name IS NOT NULL
            AND exam_name != ''
            AND is_pass = 1
            AND emp_num IS NOT NULL
            AND emp_num != ''
        ) exam ON (e.employee_number = exam.emp_num)
        LEFT JOIN t_cadre c ON (e.employee_number = c.account)
        LEFT JOIN t_expert exp ON (e.employee_number = exp.account)
        LEFT JOIN department_info_hrms dept ON (
            e.sixthdeptcode = dept.dept_code 
            AND DATE(dept.update_time) = '2025-11-18'
        )
        WHERE e.period_id = 20251126
        AND e.employee_number IS NOT NULL
        AND e.employee_number != ''
        <choose>
            <when test="deptLevel == 1">
                AND e.firstdeptcode = #{deptId}
            </when>
            <when test="deptLevel == 2">
                AND e.seconddeptcode = #{deptId}
            </when>
            <when test="deptLevel == 3">
                AND e.thirddeptcode = #{deptId}
            </when>
            <when test="deptLevel == 4">
                AND e.fourthdeptcode = #{deptId}
            </when>
            <when test="deptLevel == 5">
                AND e.fifthdeptcode = #{deptId}
            </when>
            <when test="deptLevel == 6">
                AND e.sixthdeptcode = #{deptId}
            </when>
            <when test="deptLevel == 7">
                AND 1 = 0
            </when>
        </choose>
        <!-- Ê≥®ÊÑèÔºö‰ΩøÁî?= Á≤æÁ°ÆÂåπÈÖçÂΩìÂâçÈÉ®Èó®ÁºñÁ†ÅÔºå‰∏çÊü•ËØ¢Â≠êÈÉ®Èó?-->
        <if test="jobCategory != null and jobCategory != ''">
            <choose>
                <when test="jobCategory == 'ÈùûËΩØ‰ª∂Á±ª'">
                    AND (
                        CASE 
                            WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(e.job_category, '-', 2), '-', -1)
                            WHEN e.job_category LIKE '%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                            ELSE e.job_category
                        END
                    ) != 'ËΩØ‰ª∂Á±?
                </when>
                <when test="jobCategory == 'ÂÖ∂‰ªñÁ±?">
                    AND (
                        CASE 
                            WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(e.job_category, '-', 2), '-', -1)
                            WHEN e.job_category LIKE '%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                            ELSE e.job_category
                        END
                    ) NOT IN ('Á†îÁ©∂Á±?, 'ËΩØ‰ª∂Á±?, 'Á≥ªÁªüÁ±?, 'ÊµãËØïÁ±?)
                </when>
                <otherwise>
                    AND (
                        CASE 
                            WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(e.job_category, '-', 2), '-', -1)
                            WHEN e.job_category LIKE '%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                            ELSE e.job_category
                        END
                    ) = #{jobCategory}
                </otherwise>
            </choose>
        </if>
        ORDER BY e.employee_number, COALESCE(cert.start_time, '1900-01-01')
    </select>

    <!-- Ê†πÊçÆÈÉ®Èó®Â±ÇÁ∫ßÂíåÈÉ®Èó®ÁºñÁ†ÅÂàóË°®Êü•ËØ¢ÂëòÂ∑•Â∑•Âè∑ÂíåËÅå‰ΩçÊóè‰ø°ÊÅ?-->
    <!-- Ê≥®ÊÑèÔºöÊ†πÊçÆÈÉ®Èó®Êú¨Ë∫´ÁöÑÂ±ÇÁ∫ßÊü•ËØ¢ÂØπÂ∫îÂ≠óÊÆµÔºåÂ¶ÇdeptLevel=3Êó∂Êü•ËØ¢thirddeptcode -->
    <select id="getEmployeesWithJobCategoryByDeptCodes" resultType="com.huawei.aitransform.entity.EmployeeWithCategoryVO">
        SELECT DISTINCT 
            employee_number AS employeeNumber,
            job_category AS competenceCategory
        FROM t_employee_sync
        WHERE period_id = 20251126
        <choose>
            <when test="deptLevel == 1">
                AND firstdeptcode IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </when>
            <when test="deptLevel == 2">
                AND seconddeptcode IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </when>
            <when test="deptLevel == 3">
                AND thirddeptcode IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </when>
            <when test="deptLevel == 4">
                AND fourthdeptcode IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </when>
            <when test="deptLevel == 5">
                AND fifthdeptcode IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </when>
            <when test="deptLevel == 6">
                AND sixthdeptcode IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </when>
            <when test="deptLevel == 7">
                AND 1 = 0
            </when>
        </choose>
        AND employee_number IS NOT NULL
        AND employee_number != ''
    </select>

    <!-- Ê†πÊçÆÈÉ®Èó®Â±ÇÁ∫ßÂíåÈÉ®Èó®IDÊü•ËØ¢ÂëòÂ∑•‰ªªËÅåËØ¶ÁªÜ‰ø°ÊÅØÔºàÂÖ®ÂëòÁ±ªÂûãÔºâ -->
    <!-- Ê≥®ÊÑèÔºöÂΩìÈÉ®Èó®ID‰∏ç‰∏∫0Êó∂ÔºåÂè™Êü•ËØ¢ÂΩìÂâçÈÉ®Èó®Ôºå‰∏çÊü•ËØ¢Â≠êÈÉ®Èó® -->
    <select id="getEmployeeQualifiedDetailsByDeptLevel" resultType="com.huawei.aitransform.entity.EmployeeDetailVO">
        SELECT DISTINCT
            e.last_name AS name,
            e.employee_number AS employeeNumber,
            CASE 
                WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(e.job_category, '-', 2), '-', -1)
                WHEN e.job_category LIKE '%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                ELSE e.job_category
            END AS competenceCategory,
            CASE 
                WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                ELSE NULL
            END AS competenceSubcategory,
            SUBSTRING_INDEX(e.firstdept, '/', 1) AS departname2,
            SUBSTRING_INDEX(e.seconddept, '/', 1) AS departname3,
            SUBSTRING_INDEX(e.thirddept, '/', 1) AS departname4,
            SUBSTRING_INDEX(e.fourthdept, '/', 1) AS departname5,
            SUBSTRING_INDEX(e.fifthdept, '/', 1) AS departname6,
            SUBSTRING_INDEX(e.sixthdept, '/', 1) AS departname7,
            q.competence_family_cn AS competenceFamilyCn,
            q.competence_category_cn AS competenceCategoryCn,
            q.competence_subcategory_cn AS competenceSubcategoryCn,
            q.direction_cn_name AS directionCnName,
            q.competence_rating_cn AS competenceRatingCn,
            q.competence_grade_cn AS competenceGradeCn,
            q.competence_from AS competenceFrom,
            q.competence_to AS competenceTo,
            CASE 
                WHEN c.account IS NOT NULL THEN 1 
                ELSE 0 
            END AS isCadre,
            c.cadre_type AS cadreType,
            CASE 
                WHEN exp.account IS NOT NULL THEN 1 
                ELSE 0 
            END AS isExpert,
            COALESCE(exp.position_ai_maturity, c.position_ai_maturity, NULL) AS aiMaturity,
            SUBSTRING_INDEX(dept.dept_name, '/', 1) AS miniDeptName,
            NULL AS isQualificationsStandard,
            NULL AS isCertStandard
        FROM t_employee_sync e
        <choose>
            <when test="queryType != null and queryType == 2">
                <!-- queryType=2: ‰ΩøÁî® LEFT JOINÔºåËøîÂõûÊâÄÊúâ‰∫∫ÂëòÔºåÂç≥‰ΩøÊ≤°ÊúâAI‰ªªËÅå‰πüÊòæÁ§?-->
                LEFT JOIN t_qualifications q ON (
                    e.employee_number = q.employee_number
                    AND q.employee_number IS NOT NULL
                    AND q.employee_number != ''
                    AND q.direction_cn_name IN (
                        'Êï∞ÊçÆÁßëÂ≠¶‰∏éAIÂ∑•Á®ãÔºàICTÔº?,
                        'AIÁÆóÊ≥ïÂèäÂ∫îÁî®ÔºàICTÔº?,
                        'AIËΩØ‰ª∂Â∑•Á®ã‰∏éÂ∑•ÂÖ∑ÔºàICTÔº?,
                        'AIÁ≥ªÁªüÊµãËØïÔºàICTÔº?
                    )
                    AND q.competence_from IS NOT NULL
                    AND q.competence_to IS NOT NULL
                    AND CURDATE() BETWEEN q.competence_from AND q.competence_to
                    AND q.competence_from = (
                        -- Â≠êÊü•ËØ¢ÔºöÊâæÂà∞ÊØè‰∏™ÂëòÂ∑•ÊúÄÈ´òÁ∫ßÂà´ÁöÑAI‰ªªËÅåËÆ∞ÂΩïÁöÑcompetence_from
                        SELECT q2.competence_from
                        FROM t_qualifications q2
                        WHERE q2.employee_number = e.employee_number
                        AND q2.employee_number IS NOT NULL
                        AND q2.employee_number != ''
                        AND q2.direction_cn_name IN (
                            'Êï∞ÊçÆÁßëÂ≠¶‰∏éAIÂ∑•Á®ãÔºàICTÔº?,
                            'AIÁÆóÊ≥ïÂèäÂ∫îÁî®ÔºàICTÔº?,
                            'AIËΩØ‰ª∂Â∑•Á®ã‰∏éÂ∑•ÂÖ∑ÔºàICTÔº?,
                            'AIÁ≥ªÁªüÊµãËØïÔºàICTÔº?
                        )
                        AND q2.competence_from IS NOT NULL
                        AND q2.competence_to IS NOT NULL
                        AND CURDATE() BETWEEN q2.competence_from AND q2.competence_to
                        ORDER BY 
                            CASE 
                                -- 8Á∫ßÊúÄÈ´òÔºå‰æùÊ¨°Âà?Á∫ßÔºåÂàùÁ∫ßÊúÄ‰Ω?                                WHEN q2.competence_rating_cn = '8Á∫? THEN 1
                                WHEN q2.competence_rating_cn = '7Á∫? THEN 2
                                WHEN q2.competence_rating_cn = '6Á∫? THEN 3
                                WHEN q2.competence_rating_cn = '5Á∫? THEN 4
                                WHEN q2.competence_rating_cn = '4Á∫? THEN 5
                                WHEN q2.competence_rating_cn = '3Á∫? THEN 6
                                WHEN q2.competence_rating_cn = '2Á∫? THEN 7
                                WHEN q2.competence_rating_cn = '1Á∫? THEN 8
                                WHEN q2.competence_rating_cn = 'ÂàùÁ∫ß' THEN 9
                                ELSE 10
                            END,
                            q2.competence_from DESC
                        LIMIT 1
                    )
                )
            </when>
            <otherwise>
                <!-- queryType=1: ‰ΩøÁî® INNER JOINÔºåÂè™ËøîÂõûÊúâAI‰ªªËÅåÁöÑ‰∫∫Âë?-->
                INNER JOIN t_qualifications q ON (
                    e.employee_number = q.employee_number
                    AND q.employee_number IS NOT NULL
                    AND q.employee_number != ''
                    AND q.direction_cn_name IN (
                        'Êï∞ÊçÆÁßëÂ≠¶‰∏éAIÂ∑•Á®ãÔºàICTÔº?,
                        'AIÁÆóÊ≥ïÂèäÂ∫îÁî®ÔºàICTÔº?,
                        'AIËΩØ‰ª∂Â∑•Á®ã‰∏éÂ∑•ÂÖ∑ÔºàICTÔº?,
                        'AIÁ≥ªÁªüÊµãËØïÔºàICTÔº?
                    )
                    AND q.competence_from IS NOT NULL
                    AND q.competence_to IS NOT NULL
                    AND CURDATE() BETWEEN q.competence_from AND q.competence_to
                    AND q.competence_from = (
                        -- Â≠êÊü•ËØ¢ÔºöÊâæÂà∞ÊØè‰∏™ÂëòÂ∑•ÊúÄÈ´òÁ∫ßÂà´ÁöÑAI‰ªªËÅåËÆ∞ÂΩïÁöÑcompetence_from
                        SELECT q2.competence_from
                        FROM t_qualifications q2
                        WHERE q2.employee_number = e.employee_number
                        AND q2.employee_number IS NOT NULL
                        AND q2.employee_number != ''
                        AND q2.direction_cn_name IN (
                            'Êï∞ÊçÆÁßëÂ≠¶‰∏éAIÂ∑•Á®ãÔºàICTÔº?,
                            'AIÁÆóÊ≥ïÂèäÂ∫îÁî®ÔºàICTÔº?,
                            'AIËΩØ‰ª∂Â∑•Á®ã‰∏éÂ∑•ÂÖ∑ÔºàICTÔº?,
                            'AIÁ≥ªÁªüÊµãËØïÔºàICTÔº?
                        )
                        AND q2.competence_from IS NOT NULL
                        AND q2.competence_to IS NOT NULL
                        AND CURDATE() BETWEEN q2.competence_from AND q2.competence_to
                        ORDER BY 
                            CASE 
                                -- 8Á∫ßÊúÄÈ´òÔºå‰æùÊ¨°Âà?Á∫ßÔºåÂàùÁ∫ßÊúÄ‰Ω?                                WHEN q2.competence_rating_cn = '8Á∫? THEN 1
                                WHEN q2.competence_rating_cn = '7Á∫? THEN 2
                                WHEN q2.competence_rating_cn = '6Á∫? THEN 3
                                WHEN q2.competence_rating_cn = '5Á∫? THEN 4
                                WHEN q2.competence_rating_cn = '4Á∫? THEN 5
                                WHEN q2.competence_rating_cn = '3Á∫? THEN 6
                                WHEN q2.competence_rating_cn = '2Á∫? THEN 7
                                WHEN q2.competence_rating_cn = '1Á∫? THEN 8
                                WHEN q2.competence_rating_cn = 'ÂàùÁ∫ß' THEN 9
                                ELSE 10
                            END,
                            q2.competence_from DESC
                        LIMIT 1
                    )
                )
            </otherwise>
        </choose>
        LEFT JOIN t_cadre c ON (e.employee_number = c.account)
        LEFT JOIN t_expert exp ON (e.employee_number = exp.account)
        LEFT JOIN department_info_hrms dept ON (
            e.sixthdeptcode = dept.dept_code 
            AND DATE(dept.update_time) = '2025-11-18'
        )
        WHERE e.period_id = 20251126
        AND e.employee_number IS NOT NULL
        AND e.employee_number != ''
        <choose>
            <when test="deptLevel == 1">
                AND e.firstdeptcode = #{deptId}
            </when>
            <when test="deptLevel == 2">
                AND e.seconddeptcode = #{deptId}
            </when>
            <when test="deptLevel == 3">
                AND e.thirddeptcode = #{deptId}
            </when>
            <when test="deptLevel == 4">
                AND e.fourthdeptcode = #{deptId}
            </when>
            <when test="deptLevel == 5">
                AND e.fifthdeptcode = #{deptId}
            </when>
            <when test="deptLevel == 6">
                AND e.sixthdeptcode = #{deptId}
            </when>
            <when test="deptLevel == 7">
                AND 1 = 0
            </when>
        </choose>
        <!-- Ê≥®ÊÑèÔºö‰ΩøÁî?= Á≤æÁ°ÆÂåπÈÖçÂΩìÂâçÈÉ®Èó®ÁºñÁ†ÅÔºå‰∏çÊü•ËØ¢Â≠êÈÉ®Èó?-->
        <if test="jobCategory != null and jobCategory != ''">
            <choose>
                <when test="jobCategory == 'ÈùûËΩØ‰ª∂Á±ª'">
                    AND (
                        CASE 
                            WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(e.job_category, '-', 2), '-', -1)
                            WHEN e.job_category LIKE '%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                            ELSE e.job_category
                        END
                    ) != 'ËΩØ‰ª∂Á±?
                </when>
                <when test="jobCategory == 'ÂÖ∂‰ªñÁ±?">
                    AND (
                        CASE 
                            WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(e.job_category, '-', 2), '-', -1)
                            WHEN e.job_category LIKE '%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                            ELSE e.job_category
                        END
                    ) NOT IN ('Á†îÁ©∂Á±?, 'ËΩØ‰ª∂Á±?, 'Á≥ªÁªüÁ±?, 'ÊµãËØïÁ±?)
                </when>
                <otherwise>
                    AND (
                        CASE 
                            WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(e.job_category, '-', 2), '-', -1)
                            WHEN e.job_category LIKE '%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                            ELSE e.job_category
                        END
                    ) = #{jobCategory}
                </otherwise>
            </choose>
        </if>
        ORDER BY e.employee_number, COALESCE(q.competence_from, '1900-01-01')
    </select>

</mapper>

