<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.huawei.aitransform.mapper.EmployeeMapper">

    <!-- 根据部门层级和部门ID列表查询员工工号列表 -->
    <!-- 注意：查询的部门层级为传入的deptLevel+1，即deptLevel=1时查询firstdeptcode -->
    <select id="getEmployeeNumbersByDeptLevel" resultType="java.lang.String">
        SELECT DISTINCT employee_number
        FROM t_employee_sync
        WHERE period_id = 20251126
        <choose>
            <when test="deptLevel == 1">
                AND firstdeptcode IN
                <foreach collection="deptIds" item="deptId" open="(" separator="," close=")">
                    #{deptId}
                </foreach>
            </when>
            <when test="deptLevel == 2">
                AND seconddeptcode IN
                <foreach collection="deptIds" item="deptId" open="(" separator="," close=")">
                    #{deptId}
                </foreach>
            </when>
            <when test="deptLevel == 3">
                AND thirddeptcode IN
                <foreach collection="deptIds" item="deptId" open="(" separator="," close=")">
                    #{deptId}
                </foreach>
            </when>
            <when test="deptLevel == 4">
                AND fourthdeptcode IN
                <foreach collection="deptIds" item="deptId" open="(" separator="," close=")">
                    #{deptId}
                </foreach>
            </when>
            <when test="deptLevel == 5">
                AND fifthdeptcode IN
                <foreach collection="deptIds" item="deptId" open="(" separator="," close=")">
                    #{deptId}
                </foreach>
            </when>
            <when test="deptLevel == 6">
                AND sixthdeptcode IN
                <foreach collection="deptIds" item="deptId" open="(" separator="," close=")">
                    #{deptId}
                </foreach>
            </when>
            <when test="deptLevel == 7">
                <!-- 如果deptLevel为7，已经是最高层级，无法再查询下一层 -->
                AND 1 = 0
            </when>
        </choose>
        AND employee_number IS NOT NULL
        AND employee_number != ''
    </select>

    <!-- 根据部门层级和部门ID列表查询员工工号和职位类 -->
    <!-- 注意：查询的部门层级为传入的deptLevel+1，即deptLevel=1时查询firstdeptcode -->
    <select id="getEmployeesWithCategoryByDeptLevel" resultType="com.huawei.aitransform.entity.EmployeeWithCategoryVO">
        SELECT DISTINCT 
            employee_number AS employeeNumber
        FROM t_employee_sync
        WHERE period_id = 20251126
        <choose>
            <when test="deptLevel == 1">
                AND firstdeptcode IN
                <foreach collection="deptIds" item="deptId" open="(" separator="," close=")">
                    #{deptId}
                </foreach>
            </when>
            <when test="deptLevel == 2">
                AND seconddeptcode IN
                <foreach collection="deptIds" item="deptId" open="(" separator="," close=")">
                    #{deptId}
                </foreach>
            </when>
            <when test="deptLevel == 3">
                AND thirddeptcode IN
                <foreach collection="deptIds" item="deptId" open="(" separator="," close=")">
                    #{deptId}
                </foreach>
            </when>
            <when test="deptLevel == 4">
                AND fourthdeptcode IN
                <foreach collection="deptIds" item="deptId" open="(" separator="," close=")">
                    #{deptId}
                </foreach>
            </when>
            <when test="deptLevel == 5">
                AND fifthdeptcode IN
                <foreach collection="deptIds" item="deptId" open="(" separator="," close=")">
                    #{deptId}
                </foreach>
            </when>
            <when test="deptLevel == 6">
                AND sixthdeptcode IN
                <foreach collection="deptIds" item="deptId" open="(" separator="," close=")">
                    #{deptId}
                </foreach>
            </when>
            <when test="deptLevel == 7">
                <!-- 如果deptLevel为7，已经是最高层级，无法再查询下一层 -->
                AND 1 = 0
            </when>
        </choose>
        AND employee_number IS NOT NULL
        AND employee_number != ''
    </select>

    <!-- 根据部门层级和部门ID查询员工认证详细信息（全员类型） -->
    <!-- 注意：当部门ID不为0时，只查询当前部门，不查询子部门 -->
    <!-- 使用 GROUP BY 确保每个员工只统计一次，与任职数据查询保持一致 -->
    <select id="getEmployeeCertDetailsByDeptLevel" resultType="com.huawei.aitransform.entity.EmployeeDetailVO">
        SELECT 
            ANY_VALUE(e.last_name) AS name,
            e.employee_number AS employeeNumber,
            ANY_VALUE(
                CASE 
                    WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(e.job_category, '-', 2), '-', -1)
                    WHEN e.job_category LIKE '%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                    ELSE e.job_category
                END
            ) AS competenceCategory,
            ANY_VALUE(
                CASE 
                    WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                    ELSE NULL
                END
            ) AS competenceSubcategory,
            ANY_VALUE(SUBSTRING_INDEX(e.firstdept, '/', 1)) AS departname2,
            ANY_VALUE(SUBSTRING_INDEX(e.seconddept, '/', 1)) AS departname3,
            ANY_VALUE(SUBSTRING_INDEX(e.thirddept, '/', 1)) AS departname4,
            ANY_VALUE(SUBSTRING_INDEX(e.fourthdept, '/', 1)) AS departname5,
            ANY_VALUE(SUBSTRING_INDEX(e.fifthdept, '/', 1)) AS departname6,
            ANY_VALUE(SUBSTRING_INDEX(e.sixthdept, '/', 1)) AS departname7,
            ANY_VALUE(cert.cer_title) AS certTitle,
            ANY_VALUE(cert.start_time) AS certStartTime,
            ANY_VALUE(
                CASE 
                    WHEN exam.emp_num IS NOT NULL THEN 1 
                    ELSE 0 
                END
            ) AS isPassedSubject2,
            ANY_VALUE(
                CASE 
                    WHEN c.account IS NOT NULL THEN 1 
                    ELSE 0 
                END
            ) AS isCadre,
            ANY_VALUE(c.cadre_type) AS cadreType,
            ANY_VALUE(COALESCE(c.is_cert_standard, 0)) AS isCertStandard,
            ANY_VALUE(
                CASE 
                    WHEN exp.account IS NOT NULL THEN 1 
                    ELSE 0 
                END
            ) AS isExpert,
            ANY_VALUE(COALESCE(exp.position_ai_maturity, c.position_ai_maturity, NULL)) AS aiMaturity,
            ANY_VALUE(SUBSTRING_INDEX(e.lowest_dept, '/', 1)) AS miniDeptName,
            NULL AS isQualificationsStandard
        FROM t_employee_sync e
        <choose>
            <when test="queryType != null and queryType == 2">
                <!-- queryType=2: 使用 LEFT JOIN，返回所有人员，即使没有AI专业级证书也显示 -->
                LEFT JOIN (
                    SELECT employee_number, cer_title, start_time
                    FROM dwr_t_cert_record_t
                    WHERE (status = 1 OR approved_status = 1)
                    AND (
                        cer_title = '华为研究类能力认证（专业级，AI算法技术）'
                        OR cer_title = '华为研究类能力认证（专业级，AI决策推理）'
                        OR cer_title = '华为研究类能力认证（专业级，AI图像语言语义）'
                    )
                    AND employee_number IS NOT NULL
                    AND employee_number != ''
                ) cert ON (e.employee_number = cert.employee_number)
            </when>
            <otherwise>
                <!-- queryType=1: 使用 INNER JOIN，只返回有AI专业级证书的人员 -->
                INNER JOIN (
                    SELECT employee_number, cer_title, start_time
                    FROM dwr_t_cert_record_t
                    WHERE (status = 1 OR approved_status = 1)
                    AND (
                        cer_title = '华为研究类能力认证（专业级，AI算法技术）'
                        OR cer_title = '华为研究类能力认证（专业级，AI决策推理）'
                        OR cer_title = '华为研究类能力认证（专业级，AI图像语言语义）'
                    )
                    AND employee_number IS NOT NULL
                    AND employee_number != ''
                ) cert ON (e.employee_number = cert.employee_number)
            </otherwise>
        </choose>
        LEFT JOIN (
            SELECT DISTINCT emp_num
            FROM t_exam_record
            WHERE exam_name IS NOT NULL
            AND exam_name != ''
            AND is_pass = 1
            AND emp_num IS NOT NULL
            AND emp_num != ''
        ) exam ON (e.employee_number = exam.emp_num)
        LEFT JOIN t_cadre c ON (e.employee_number = c.account)
        LEFT JOIN t_expert exp ON (e.employee_number = exp.account)
        WHERE e.period_id = 20251126
        AND e.employee_number IS NOT NULL
        AND e.employee_number != ''
        <choose>
            <when test="deptLevel == 1">
                AND e.firstdeptcode = #{deptId}
            </when>
            <when test="deptLevel == 2">
                AND e.seconddeptcode = #{deptId}
            </when>
            <when test="deptLevel == 3">
                AND e.thirddeptcode = #{deptId}
            </when>
            <when test="deptLevel == 4">
                AND e.fourthdeptcode = #{deptId}
            </when>
            <when test="deptLevel == 5">
                AND e.fifthdeptcode = #{deptId}
            </when>
            <when test="deptLevel == 6">
                AND e.sixthdeptcode = #{deptId}
            </when>
            <when test="deptLevel == 7">
                AND 1 = 0
            </when>
        </choose>
        <!-- 注意：使用 = 精确匹配当前部门编码，不查询子部门 -->
        <if test="jobCategory != null and jobCategory != ''">
            <choose>
                <when test="jobCategory == '非软件类'">
                    AND (
                        CASE 
                            WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(e.job_category, '-', 2), '-', -1)
                            WHEN e.job_category LIKE '%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                            ELSE e.job_category
                        END
                    ) != '软件类'
                </when>
                <when test="jobCategory == '其他类'">
                    AND (
                        CASE 
                            WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(e.job_category, '-', 2), '-', -1)
                            WHEN e.job_category LIKE '%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                            ELSE e.job_category
                        END
                    ) NOT IN ('研究类', '软件类', '系统类', '测试类', '产品开发项目管理类')
                </when>
                <otherwise>
                    AND (
                        CASE 
                            WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(e.job_category, '-', 2), '-', -1)
                            WHEN e.job_category LIKE '%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                            ELSE e.job_category
                        END
                    ) = #{jobCategory}
                </otherwise>
            </choose>
        </if>
        GROUP BY e.employee_number
        ORDER BY e.employee_number, COALESCE(MAX(cert.start_time), '1900-01-01')
    </select>

    <!-- 根据部门层级和部门编码列表查询员工工号和职位族信息 -->
    <!-- 注意：根据部门本身的层级查询对应字段，如deptLevel=3时查询thirddeptcode -->
    <select id="getEmployeesWithJobCategoryByDeptCodes" resultType="com.huawei.aitransform.entity.EmployeeWithCategoryVO">
        SELECT DISTINCT 
            employee_number AS employeeNumber,
            job_category AS competenceCategory
        FROM t_employee_sync
        WHERE period_id = 20251126
        <choose>
            <when test="deptLevel == 1">
                AND firstdeptcode IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </when>
            <when test="deptLevel == 2">
                AND seconddeptcode IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </when>
            <when test="deptLevel == 3">
                AND thirddeptcode IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </when>
            <when test="deptLevel == 4">
                AND fourthdeptcode IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </when>
            <when test="deptLevel == 5">
                AND fifthdeptcode IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </when>
            <when test="deptLevel == 6">
                AND sixthdeptcode IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </when>
            <when test="deptLevel == 7">
                AND 1 = 0
            </when>
        </choose>
        AND employee_number IS NOT NULL
        AND employee_number != ''
    </select>

    <!-- 根据部门层级和部门ID查询员工任职详细信息（全员类型） -->
    <!-- 注意：当部门ID不为0时，只查询当前部门，不查询子部门 -->
    <select id="getEmployeeQualifiedDetailsByDeptLevel" resultType="com.huawei.aitransform.entity.EmployeeDetailVO">
        SELECT 
            ANY_VALUE(e.last_name) AS name,
            e.employee_number AS employeeNumber,
            ANY_VALUE(
                CASE 
                    WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(e.job_category, '-', 2), '-', -1)
                    WHEN e.job_category LIKE '%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                    ELSE e.job_category
                END
            ) AS competenceCategory,
            ANY_VALUE(
                CASE 
                    WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                    ELSE NULL
                END
            ) AS competenceSubcategory,
            ANY_VALUE(SUBSTRING_INDEX(e.firstdept, '/', 1)) AS departname2,
            ANY_VALUE(SUBSTRING_INDEX(e.seconddept, '/', 1)) AS departname3,
            ANY_VALUE(SUBSTRING_INDEX(e.thirddept, '/', 1)) AS departname4,
            ANY_VALUE(SUBSTRING_INDEX(e.fourthdept, '/', 1)) AS departname5,
            ANY_VALUE(SUBSTRING_INDEX(e.fifthdept, '/', 1)) AS departname6,
            ANY_VALUE(SUBSTRING_INDEX(e.sixthdept, '/', 1)) AS departname7,
            ANY_VALUE(q.competence_family_cn) AS competenceFamilyCn,
            ANY_VALUE(q.competence_category_cn) AS competenceCategoryCn,
            ANY_VALUE(q.competence_subcategory_cn) AS competenceSubcategoryCn,
            ANY_VALUE(q.direction_cn_name) AS directionCnName,
            ANY_VALUE(q.competence_rating_cn) AS competenceRatingCn,
            ANY_VALUE(q.competence_grade_cn) AS competenceGradeCn,
            ANY_VALUE(q.competence_from) AS competenceFrom,
            ANY_VALUE(q.competence_to) AS competenceTo,
            ANY_VALUE(
                CASE 
                    WHEN c.account IS NOT NULL THEN 1 
                    ELSE 0 
                END
            ) AS isCadre,
            ANY_VALUE(c.cadre_type) AS cadreType,
            ANY_VALUE(
                CASE 
                    WHEN exp.account IS NOT NULL THEN 1 
                    ELSE 0 
                END
            ) AS isExpert,
            ANY_VALUE(COALESCE(exp.position_ai_maturity, c.position_ai_maturity, NULL)) AS aiMaturity,
            ANY_VALUE(SUBSTRING_INDEX(e.lowest_dept, '/', 1)) AS miniDeptName,
            NULL AS isQualificationsStandard,
            NULL AS isCertStandard
        FROM t_employee_sync e
        <choose>
            <when test="queryType != null and queryType == 2">
                <!-- queryType=2: 使用 LEFT JOIN，返回所有人员，即使没有AI任职也显示 -->
                LEFT JOIN t_qualifications q ON (
                    e.employee_number = q.employee_number
                    AND q.employee_number IS NOT NULL
                    AND q.employee_number != ''
                    AND q.direction_cn_name IN (
                        '数据科学与AI工程（ICT）',
                        'AI算法及应用（ICT）',
                        'AI软件工程与工具（ICT）',
                        'AI系统测试（ICT）'
                    )
                    AND q.competence_from IS NOT NULL
                    AND q.competence_to IS NOT NULL
                    AND q.competence_from = (
                        -- 子查询：找到每个员工最高级别的AI任职记录的competence_from
                        -- 注意：移除日期限制，查询所有任职记录（包括已过期的），与认证数据查询逻辑保持一致
                        SELECT q2.competence_from
                        FROM t_qualifications q2
                        WHERE q2.employee_number = e.employee_number
                        AND q2.employee_number IS NOT NULL
                        AND q2.employee_number != ''
                        AND q2.direction_cn_name IN (
                            '数据科学与AI工程（ICT）',
                            'AI算法及应用（ICT）',
                            'AI软件工程与工具（ICT）',
                            'AI系统测试（ICT）'
                        )
                        AND q2.competence_from IS NOT NULL
                        AND q2.competence_to IS NOT NULL
                        ORDER BY 
                            CASE 
                                -- 8级最高，依次到1级，初级最低
                                WHEN q2.competence_rating_cn = '8级' THEN 1
                                WHEN q2.competence_rating_cn = '7级' THEN 2
                                WHEN q2.competence_rating_cn = '6级' THEN 3
                                WHEN q2.competence_rating_cn = '5级' THEN 4
                                WHEN q2.competence_rating_cn = '4级' THEN 5
                                WHEN q2.competence_rating_cn = '3级' THEN 6
                                WHEN q2.competence_rating_cn = '2级' THEN 7
                                WHEN q2.competence_rating_cn = '1级' THEN 8
                                WHEN q2.competence_rating_cn = '初级' THEN 9
                                ELSE 10
                            END,
                            q2.competence_from DESC
                        LIMIT 1
                    )
                )
            </when>
            <otherwise>
                <!-- queryType=1: 使用 INNER JOIN，只返回有AI任职的人员 -->
                INNER JOIN t_qualifications q ON (
                    e.employee_number = q.employee_number
                    AND q.employee_number IS NOT NULL
                    AND q.employee_number != ''
                    AND q.direction_cn_name IN (
                        '数据科学与AI工程（ICT）',
                        'AI算法及应用（ICT）',
                        'AI软件工程与工具（ICT）',
                        'AI系统测试（ICT）'
                    )
                    AND q.competence_from IS NOT NULL
                    AND q.competence_to IS NOT NULL
                    AND q.competence_from = (
                        -- 子查询：找到每个员工最高级别的AI任职记录的competence_from
                        -- 注意：移除日期限制，查询所有任职记录（包括已过期的），与认证数据查询逻辑保持一致
                        SELECT q2.competence_from
                        FROM t_qualifications q2
                        WHERE q2.employee_number = e.employee_number
                        AND q2.employee_number IS NOT NULL
                        AND q2.employee_number != ''
                        AND q2.direction_cn_name IN (
                            '数据科学与AI工程（ICT）',
                            'AI算法及应用（ICT）',
                            'AI软件工程与工具（ICT）',
                            'AI系统测试（ICT）'
                        )
                        AND q2.competence_from IS NOT NULL
                        AND q2.competence_to IS NOT NULL
                        ORDER BY 
                            CASE 
                                -- 8级最高，依次到1级，初级最低
                                WHEN q2.competence_rating_cn = '8级' THEN 1
                                WHEN q2.competence_rating_cn = '7级' THEN 2
                                WHEN q2.competence_rating_cn = '6级' THEN 3
                                WHEN q2.competence_rating_cn = '5级' THEN 4
                                WHEN q2.competence_rating_cn = '4级' THEN 5
                                WHEN q2.competence_rating_cn = '3级' THEN 6
                                WHEN q2.competence_rating_cn = '2级' THEN 7
                                WHEN q2.competence_rating_cn = '1级' THEN 8
                                WHEN q2.competence_rating_cn = '初级' THEN 9
                                ELSE 10
                            END,
                            q2.competence_from DESC
                        LIMIT 1
                    )
                )
            </otherwise>
        </choose>
        LEFT JOIN t_cadre c ON (e.employee_number = c.account)
        LEFT JOIN t_expert exp ON (e.employee_number = exp.account)
        WHERE e.period_id = 20251126
        AND e.employee_number IS NOT NULL
        AND e.employee_number != ''
        <choose>
            <when test="deptLevel == 1">
                AND e.firstdeptcode = #{deptId}
            </when>
            <when test="deptLevel == 2">
                AND e.seconddeptcode = #{deptId}
            </when>
            <when test="deptLevel == 3">
                AND e.thirddeptcode = #{deptId}
            </when>
            <when test="deptLevel == 4">
                AND e.fourthdeptcode = #{deptId}
            </when>
            <when test="deptLevel == 5">
                AND e.fifthdeptcode = #{deptId}
            </when>
            <when test="deptLevel == 6">
                AND e.sixthdeptcode = #{deptId}
            </when>
            <when test="deptLevel == 7">
                AND 1 = 0
            </when>
        </choose>
        <!-- 注意：使用 = 精确匹配当前部门编码，不查询子部门 -->
        <if test="jobCategory != null and jobCategory != ''">
            <choose>
                <when test="jobCategory == '非软件类'">
                    AND (
                        CASE 
                            WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(e.job_category, '-', 2), '-', -1)
                            WHEN e.job_category LIKE '%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                            ELSE e.job_category
                        END
                    ) != '软件类'
                </when>
                <when test="jobCategory == '其他类'">
                    AND (
                        CASE 
                            WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(e.job_category, '-', 2), '-', -1)
                            WHEN e.job_category LIKE '%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                            ELSE e.job_category
                        END
                    ) NOT IN ('研究类', '软件类', '系统类', '测试类', '产品开发项目管理类')
                </when>
                <otherwise>
                    AND (
                        CASE 
                            WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(e.job_category, '-', 2), '-', -1)
                            WHEN e.job_category LIKE '%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                            ELSE e.job_category
                        END
                    ) = #{jobCategory}
                </otherwise>
            </choose>
        </if>
        GROUP BY e.employee_number
        ORDER BY e.employee_number, COALESCE(q.competence_from, '1900-01-01')
    </select>

</mapper>

