<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.huawei.aitransform.mapper.AiCertStatisticsMapper">

    <!-- 根据部门层级获取部门编码列表 -->
    <select id="getDeptCodesByLevel" parameterType="java.lang.Integer" resultType="java.lang.String">
        SELECT dept_code
        FROM t_mes_ct_dept
        WHERE dept_level = #{deptLevel}
        AND enabled = 1
        ORDER BY dept_code
    </select>

    <!-- 统计各个部门的总人数 -->
    <select id="countTotalEmployeesByDept" parameterType="java.lang.Integer" resultType="com.huawei.aitransform.entity.AiCertStatisticsVO">
        SELECT 
            <choose>
                <when test="deptLevel == 2">
                    t.departname2 AS deptName,
                    t.department2_id AS deptCode
                </when>
                <when test="deptLevel == 3">
                    t.departname3 AS deptName,
                    t.department3_id AS deptCode
                </when>
                <when test="deptLevel == 4">
                    t.departname4 AS deptName,
                    t.department4_id AS deptCode
                </when>
            </choose>,
            COUNT(DISTINCT t.account) AS totalCount
        FROM t_employee t
        WHERE 
            <choose>
                <when test="deptLevel == 2">
                    t.department2_id IS NOT NULL AND t.department2_id != ''
                </when>
                <when test="deptLevel == 3">
                    t.department3_id IS NOT NULL AND t.department3_id != ''
                </when>
                <when test="deptLevel == 4">
                    t.department4_id IS NOT NULL AND t.department4_id != ''
                </when>
            </choose>
        GROUP BY 
            <choose>
                <when test="deptLevel == 2">
                    t.departname2, t.department2_id
                </when>
                <when test="deptLevel == 3">
                    t.departname3, t.department3_id
                </when>
                <when test="deptLevel == 4">
                    t.departname4, t.department4_id
                </when>
            </choose>
        ORDER BY deptCode
    </select>

    <!-- 统计各个部门持有AI证书的人数 -->
    <select id="countCertEmployeesByDept" parameterType="java.lang.Integer" resultType="com.huawei.aitransform.entity.AiCertStatisticsVO">
        SELECT 
            <choose>
                <when test="deptLevel == 2">
                    c.l2_department_cn_name AS deptName,
                    c.l2_department_code AS deptCode
                </when>
                <when test="deptLevel == 3">
                    c.l3_department_cn_name AS deptName,
                    c.l3_department_code AS deptCode
                </when>
                <when test="deptLevel == 4">
                    c.l4_department_cn_name AS deptName,
                    c.l4_department_code AS deptCode
                </when>
            </choose>,
            COUNT(DISTINCT c.w3_account) AS certCount
        FROM dwr_t_cert_record_t c
        WHERE c.status = 1
        AND (
            c.cer_title LIKE '%华为研究类能力认证（专业级，AI算法技术）%'
            OR c.cer_title LIKE '%华为研究类能力认证（专业级，AI软件技术）%'
        )
        AND 
            <choose>
                <when test="deptLevel == 2">
                    c.l2_department_code IS NOT NULL AND c.l2_department_code != ''
                </when>
                <when test="deptLevel == 3">
                    c.l3_department_code IS NOT NULL AND c.l3_department_code != ''
                </when>
                <when test="deptLevel == 4">
                    c.l4_department_code IS NOT NULL AND c.l4_department_code != ''
                </when>
            </choose>
        GROUP BY 
            <choose>
                <when test="deptLevel == 2">
                    c.l2_department_cn_name, c.l2_department_code
                </when>
                <when test="deptLevel == 3">
                    c.l3_department_cn_name, c.l3_department_code
                </when>
                <when test="deptLevel == 4">
                    c.l4_department_cn_name, c.l4_department_code
                </when>
            </choose>
        ORDER BY deptCode
    </select>

</mapper>

