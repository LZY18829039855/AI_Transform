<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.huawei.aitransform.mapper.CadreMapper">

    <!-- 根据部门编码列表查询干部工号列表 -->
    <!-- 只匹配最小部门编码（mini_departname_id）字段 -->
    <select id="getCadreEmployeeNumbersByDeptCodes" resultType="java.lang.String">
        SELECT DISTINCT account
        FROM t_cadre
        <where>
            <if test="deptCodes != null and deptCodes.size() > 0">
                mini_departname_id IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </if>
            AND account IS NOT NULL
            AND account != ''
        </where>
    </select>

    <!-- 根据部门编码列表查询干部工号和职位类 -->
    <!-- 只匹配最小部门编码（mini_departname_id）字段 -->
    <select id="getCadreEmployeesWithCategoryByDeptCodes" resultType="com.huawei.aitransform.entity.EmployeeWithCategoryVO">
        SELECT DISTINCT
            account AS employeeNumber,
            COALESCE(cadre_competence_category, '未知') AS competenceCategory
        FROM t_cadre
        <where>
            <if test="deptCodes != null and deptCodes.size() > 0">
                mini_departname_id IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </if>
            AND account IS NOT NULL
            AND account != ''
        </where>
    </select>

    <!-- 根据部门编码列表查询干部信息（工号、部门编码、职位类、AI成熟度） -->
    <!-- 只匹配最小部门编码（mini_departname_id）字段 -->
    <select id="getCadreInfoByDeptCodes" resultType="com.huawei.aitransform.entity.CadreInfoVO">
        SELECT DISTINCT
            account AS employeeNumber,
            mini_departname_id AS deptCode,
            COALESCE(cadre_competence_category, '未知') AS jobCategory,
            COALESCE(position_ai_maturity, '未知') AS aiMaturity,
            COALESCE(is_qualifications_standard, 0) AS isQualificationsStandard,
            COALESCE(is_cert_standard, 0) AS isCertStandard
        FROM t_cadre
        <where>
            <if test="deptCodes != null and deptCodes.size() > 0">
                mini_departname_id IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </if>
            AND account IS NOT NULL
            AND account != ''
        </where>
    </select>

    <!-- 根据部门编码列表、AI成熟度和职位类查询干部认证详细信息 -->
    <select id="getCadreCertDetailsByConditions" resultType="com.huawei.aitransform.entity.EmployeeDetailVO">
        SELECT DISTINCT
            e.last_name AS name,
            e.employee_number AS employeeNumber,
            COALESCE(c.cadre_competence_category, '未知') AS competenceCategory,
            CASE 
                WHEN e.job_category LIKE '%-%-%' THEN SUBSTRING_INDEX(e.job_category, '-', -1)
                ELSE NULL
            END AS competenceSubcategory,
            c.departname1 AS departname2,
            c.departname2 AS departname3,
            c.departname3 AS departname4,
            c.departname4 AS departname5,
            c.departname5 AS departname6,
            cert.cer_title AS certTitle,
            cert.start_time AS certStartTime,
            CASE 
                WHEN exam.emp_num IS NOT NULL THEN 1 
                ELSE 0 
            END AS isPassedSubject2,
            1 AS isCadre,
            COALESCE(c.is_cert_standard, 0) AS isCertStandard,
            COALESCE(c.position_ai_maturity, '未知') AS aiMaturity,
            SUBSTRING_INDEX(dept.dept_name, '/', 1) AS miniDeptName,
            c.cadre_type AS cadreType
        FROM t_cadre c
        INNER JOIN t_employee_sync e ON (e.employee_number = c.account)
        <choose>
            <when test="queryType != null and queryType == 2">
                <!-- queryType=2: 使用 LEFT JOIN，返回所有人员，即使没有AI专业级证书也显示 -->
                LEFT JOIN (
                    SELECT DISTINCT
                        employee_number, 
                        cer_title,
                        start_time
                    FROM dwr_t_cert_record_t
                    WHERE (status = 1 OR approved_status = 1)
                    AND (
                        -- 华为研究类能力认证（专业级，xxx）
                        cer_title = '华为研究类能力认证（专业级，AI算法技术）'
                        OR cer_title = '华为研究类能力认证（专业级，AI决策推理）'
                        OR cer_title = '华为研究类能力认证（专业级，AI图像语言语义）'
                    )
                    AND employee_number IS NOT NULL
                    AND employee_number != ''
                ) cert ON (e.employee_number = cert.employee_number)
            </when>
            <otherwise>
                <!-- queryType=1: 使用 INNER JOIN，只返回有AI专业级证书的人员 -->
                INNER JOIN (
                    SELECT DISTINCT
                        employee_number, 
                        cer_title,
                        start_time
                    FROM dwr_t_cert_record_t
                    WHERE (status = 1 OR approved_status = 1)
                    AND (
                        -- 华为研究类能力认证（专业级，xxx）
                        cer_title = '华为研究类能力认证（专业级，AI算法技术）'
                        OR cer_title = '华为研究类能力认证（专业级，AI决策推理）'
                        OR cer_title = '华为研究类能力认证（专业级，AI图像语言语义）'
                    )
                    AND employee_number IS NOT NULL
                    AND employee_number != ''
                ) cert ON (e.employee_number = cert.employee_number)
            </otherwise>
        </choose>
        LEFT JOIN (
            SELECT DISTINCT emp_num
            FROM t_exam_record
            WHERE exam_name IS NOT NULL
            AND exam_name != ''
            AND is_pass = 1
            AND emp_num IS NOT NULL
            AND emp_num != ''
        ) exam ON (e.employee_number = exam.emp_num)
        LEFT JOIN department_info_hrms dept ON (c.mini_departname_id = dept.dept_code AND DATE(dept.update_time) = '2025-11-18')
        WHERE e.period_id = 20251126
        <if test="deptCodes != null and deptCodes.size() > 0">
            AND c.mini_departname_id IN
            <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                #{deptCode}
            </foreach>
        </if>
        <if test="aiMaturity != null and aiMaturity != ''">
            <choose>
                <when test="'L5'.equals(aiMaturity)">
                    <!-- 当aiMaturity为L5时，查询L2和L3的数据（L5代表查询L2和L3） -->
                    AND c.position_ai_maturity IN ('L2', 'L3')
                </when>
                <otherwise>
                    AND COALESCE(c.position_ai_maturity, '未知') = #{aiMaturity}
                </otherwise>
            </choose>
        </if>
        <if test="jobCategory != null and jobCategory != ''">
            AND COALESCE(c.cadre_competence_category, '未知') = #{jobCategory}
        </if>
        AND c.account IS NOT NULL
        AND c.account != ''
        AND e.employee_number IS NOT NULL
        AND e.employee_number != ''
        ORDER BY e.employee_number
    </select>

    <!-- 根据部门编码列表、AI成熟度和职位类查询干部任职详细信息 -->
    <!-- queryType=1: 查询有AI相关任职的人员信息 -->
    <!-- queryType=2: 查询符合条件的所有成员，即使没有AI任职信息也显示人员信息，AI任职信息为空 -->
    <!-- 每人最多显示一条信息，如果有多条AI任职结果，选取任职级别最高的一条展示 -->
    <select id="getCadreQualifiedDetailsByConditions" resultType="com.huawei.aitransform.entity.EmployeeDetailVO">
        SELECT 
            ANY_VALUE(e.last_name) AS name,
            e.employee_number AS employeeNumber,
            ANY_VALUE(COALESCE(c.cadre_competence_category, '未知')) AS competenceCategory,
            ANY_VALUE(c.departname1) AS departname2,
            ANY_VALUE(c.departname2) AS departname3,
            ANY_VALUE(c.departname3) AS departname4,
            ANY_VALUE(c.departname4) AS departname5,
            ANY_VALUE(c.departname5) AS departname6,
            ANY_VALUE(q.competence_family_cn) AS competenceFamilyCn,
            ANY_VALUE(q.competence_category_cn) AS competenceCategoryCn,
            ANY_VALUE(q.competence_subcategory_cn) AS competenceSubcategoryCn,
            ANY_VALUE(q.direction_cn_name) AS directionCnName,
            ANY_VALUE(q.competence_rating_cn) AS competenceRatingCn,
            ANY_VALUE(q.competence_grade_cn) AS competenceGradeCn,
            ANY_VALUE(q.competence_from) AS competenceFrom,
            ANY_VALUE(q.competence_to) AS competenceTo,
            ANY_VALUE(COALESCE(c.position_ai_maturity, '未知')) AS aiMaturity,
            1 AS isCadre,
            ANY_VALUE(SUBSTRING_INDEX(dept.dept_name, '/', 1)) AS miniDeptName,
            ANY_VALUE(c.cadre_type) AS cadreType,
            ANY_VALUE(COALESCE(c.is_qualifications_standard, 0)) AS isQualificationsStandard
        FROM t_cadre c
        INNER JOIN t_employee_sync e ON (e.employee_number = c.account)
        <choose>
            <when test="queryType != null and queryType == 2">
                <!-- queryType=2: 使用 LEFT JOIN，返回所有人员，即使没有AI任职也显示 -->
                LEFT JOIN t_qualifications q ON (
                    c.account = q.employee_number
                    AND q.employee_number IS NOT NULL
                    AND q.employee_number != ''
                    AND q.direction_cn_name IN (
                        '数据科学与AI工程（ICT）',
                        'AI算法及应用（ICT）',
                        'AI软件工程与工具（ICT）',
                        'AI系统测试（ICT）'
                    )
                    AND q.competence_from IS NOT NULL
                    AND q.competence_to IS NOT NULL
                    AND q.competence_from = (
                        -- 子查询：找到每个员工最高级别的AI任职记录的competence_from
                        SELECT q2.competence_from
                        FROM t_qualifications q2
                        WHERE q2.employee_number = c.account
                        AND q2.employee_number IS NOT NULL
                        AND q2.employee_number != ''
                        AND q2.direction_cn_name IN (
                            '数据科学与AI工程（ICT）',
                            'AI算法及应用（ICT）',
                            'AI软件工程与工具（ICT）',
                            'AI系统测试（ICT）'
                        )
                        AND q2.competence_from IS NOT NULL
                        AND q2.competence_to IS NOT NULL
                        ORDER BY 
                            CASE 
                                -- 8级最高，依次到1级，初级最低
                                WHEN q2.competence_rating_cn = '8级' THEN 1
                                WHEN q2.competence_rating_cn = '7级' THEN 2
                                WHEN q2.competence_rating_cn = '6级' THEN 3
                                WHEN q2.competence_rating_cn = '5级' THEN 4
                                WHEN q2.competence_rating_cn = '4级' THEN 5
                                WHEN q2.competence_rating_cn = '3级' THEN 6
                                WHEN q2.competence_rating_cn = '2级' THEN 7
                                WHEN q2.competence_rating_cn = '1级' THEN 8
                                WHEN q2.competence_rating_cn = '初级' THEN 9
                                ELSE 10
                            END,
                            q2.competence_from DESC
                        LIMIT 1
                    )
                )
            </when>
            <otherwise>
                <!-- queryType=1: 使用 INNER JOIN，只返回有AI任职记录的干部 -->
                INNER JOIN t_qualifications q ON (
                    c.account = q.employee_number
                    AND q.employee_number IS NOT NULL
                    AND q.employee_number != ''
                    AND q.direction_cn_name IN (
                        '数据科学与AI工程（ICT）',
                        'AI算法及应用（ICT）',
                        'AI软件工程与工具（ICT）',
                        'AI系统测试（ICT）'
                    )
                    AND q.competence_from IS NOT NULL
                    AND q.competence_to IS NOT NULL
                    AND q.competence_from = (
                        -- 子查询：找到每个员工最高级别的AI任职记录的competence_from
                        SELECT q2.competence_from
                        FROM t_qualifications q2
                        WHERE q2.employee_number = c.account
                        AND q2.employee_number IS NOT NULL
                        AND q2.employee_number != ''
                        AND q2.direction_cn_name IN (
                            '数据科学与AI工程（ICT）',
                            'AI算法及应用（ICT）',
                            'AI软件工程与工具（ICT）',
                            'AI系统测试（ICT）'
                        )
                        AND q2.competence_from IS NOT NULL
                        AND q2.competence_to IS NOT NULL
                        ORDER BY 
                            CASE 
                                -- 8级最高，依次到1级，初级最低
                                WHEN q2.competence_rating_cn = '8级' THEN 1
                                WHEN q2.competence_rating_cn = '7级' THEN 2
                                WHEN q2.competence_rating_cn = '6级' THEN 3
                                WHEN q2.competence_rating_cn = '5级' THEN 4
                                WHEN q2.competence_rating_cn = '4级' THEN 5
                                WHEN q2.competence_rating_cn = '3级' THEN 6
                                WHEN q2.competence_rating_cn = '2级' THEN 7
                                WHEN q2.competence_rating_cn = '1级' THEN 8
                                WHEN q2.competence_rating_cn = '初级' THEN 9
                                ELSE 10
                            END,
                            q2.competence_from DESC
                        LIMIT 1
                    )
                )
            </otherwise>
        </choose>
        LEFT JOIN department_info_hrms dept ON (c.mini_departname_id = dept.dept_code AND DATE(dept.update_time) = '2025-11-18')
        WHERE e.period_id = 20251126
        <if test="deptCodes != null and deptCodes.size() > 0">
            AND c.mini_departname_id IN
            <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                #{deptCode}
            </foreach>
        </if>
        <if test="aiMaturity != null and aiMaturity != ''">
            <choose>
                <when test="'L5'.equals(aiMaturity)">
                    <!-- 当aiMaturity为L5时，查询L2和L3的数据（L5代表查询L2和L3） -->
                    AND c.position_ai_maturity IN ('L2', 'L3')
                </when>
                <otherwise>
                    AND COALESCE(c.position_ai_maturity, '未知') = #{aiMaturity}
                </otherwise>
            </choose>
        </if>
        <if test="jobCategory != null and jobCategory != ''">
            AND COALESCE(c.cadre_competence_category, '未知') = #{jobCategory}
        </if>
        AND c.account IS NOT NULL
        AND c.account != ''
        AND e.employee_number IS NOT NULL
        AND e.employee_number != ''
        ORDER BY e.employee_number
    </select>

    <!-- 查询所有L2、L3干部及其最高AI任职级别、职位类、专业级证书、科目二通过情况 -->
    <select id="getL2L3CadreWithHighestQualification" resultType="com.huawei.aitransform.entity.CadreQualificationVO">
        SELECT 
            c.account AS employeeNumber,
            COALESCE(c.position_ai_maturity, '未知') AS aiMaturity,
            q.competence_rating_cn AS highestQualificationLevel,
            COALESCE(c.cadre_competence_category, '未知') AS jobCategory,
            CASE 
                WHEN cert.employee_number IS NOT NULL THEN 1 
                ELSE 0 
            END AS hasProfessionalCert,
            CASE 
                WHEN exam.emp_num IS NOT NULL THEN 1 
                ELSE 0 
            END AS hasPassedSubject2
        FROM t_cadre c
        INNER JOIN t_employee_sync e ON (e.employee_number = c.account)
        LEFT JOIN (
            SELECT 
                q1.employee_number,
                q1.competence_rating_cn
            FROM t_qualifications q1
            WHERE q1.employee_number IS NOT NULL
            AND q1.employee_number != ''
            AND q1.direction_cn_name IN (
                '数据科学与AI工程（ICT）',
                'AI算法及应用（ICT）',
                'AI软件工程与工具（ICT）',
                'AI系统测试（ICT）'
            )
            AND q1.competence_from IS NOT NULL
            AND q1.competence_to IS NOT NULL
            AND q1.competence_from = (
                -- 子查询：找到每个员工最高级别的AI任职记录的competence_from
                SELECT q2.competence_from
                FROM t_qualifications q2
                WHERE q2.employee_number = q1.employee_number
                AND q2.employee_number IS NOT NULL
                AND q2.employee_number != ''
                AND q2.direction_cn_name IN (
                    '数据科学与AI工程（ICT）',
                    'AI算法及应用（ICT）',
                    'AI软件工程与工具（ICT）',
                    'AI系统测试（ICT）'
                )
                AND q2.competence_from IS NOT NULL
                AND q2.competence_to IS NOT NULL
                ORDER BY 
                    CASE 
                        -- 8级最高，依次到1级，初级最低
                        WHEN q2.competence_rating_cn = '8级' THEN 1
                        WHEN q2.competence_rating_cn = '7级' THEN 2
                        WHEN q2.competence_rating_cn = '6级' THEN 3
                        WHEN q2.competence_rating_cn = '5级' THEN 4
                        WHEN q2.competence_rating_cn = '4级' THEN 5
                        WHEN q2.competence_rating_cn = '3级' THEN 6
                        WHEN q2.competence_rating_cn = '2级' THEN 7
                        WHEN q2.competence_rating_cn = '1级' THEN 8
                        WHEN q2.competence_rating_cn = '初级' THEN 9
                        ELSE 10
                    END,
                    q2.competence_from DESC
                LIMIT 1
            )
        ) q ON (c.account = q.employee_number)
        LEFT JOIN (
            SELECT DISTINCT
                employee_number
            FROM dwr_t_cert_record_t
            WHERE (status = 1 OR approved_status = 1)
            AND (
                -- 华为研究类能力认证（专业级，xxx）
                cer_title = '华为研究类能力认证（专业级，AI算法技术）'
                OR cer_title = '华为研究类能力认证（专业级，AI决策推理）'
                OR cer_title = '华为研究类能力认证（专业级，AI图像语言语义）'
            )
            AND employee_number IS NOT NULL
                    AND employee_number != ''
        ) cert ON (e.employee_number = cert.employee_number )
        LEFT JOIN (
            SELECT DISTINCT emp_num
            FROM t_exam_record
            WHERE exam_code IN ('EXCN022303075ZA20', 'EXCN022303075ZA2E', 'EXCN022303075ZA2A')
            AND is_pass = 1
            AND emp_num IS NOT NULL
            AND emp_num != ''
        ) exam ON (e.employee_number = exam.emp_num)
        WHERE c.position_ai_maturity IN ('L2', 'L3')
        AND c.account IS NOT NULL
        AND c.account != ''
        AND e.period_id = 20251126
        ORDER BY c.account
    </select>

    <!-- 批量更新干部的is_qualifications_standard字段为1 -->
    <update id="batchUpdateQualificationStandard">
        UPDATE t_cadre
        SET is_qualifications_standard = 1
        WHERE account IN
        <foreach collection="employeeNumbers" item="employeeNumber" open="(" separator="," close=")">
            #{employeeNumber}
        </foreach>
    </update>

    <!-- 批量将干部的is_qualifications_standard字段重置为0 -->
    <update id="batchResetQualificationStandard">
        UPDATE t_cadre
        SET is_qualifications_standard = 0
        WHERE account IN
        <foreach collection="employeeNumbers" item="employeeNumber" open="(" separator="," close=")">
            #{employeeNumber}
        </foreach>
    </update>

    <!-- 批量更新干部的is_cert_standard字段为1 -->
    <update id="batchUpdateCertStandard">
        UPDATE t_cadre
        SET is_cert_standard = 1
        WHERE account IN
        <foreach collection="employeeNumbers" item="employeeNumber" open="(" separator="," close=")">
            #{employeeNumber}
        </foreach>
    </update>

    <!-- 批量将干部的is_cert_standard字段重置为0 -->
    <update id="batchResetCertStandard">
        UPDATE t_cadre
        SET is_cert_standard = 0
        WHERE account IN
        <foreach collection="employeeNumbers" item="employeeNumber" open="(" separator="," close=")">
            #{employeeNumber}
        </foreach>
    </update>

    <!-- 查询所有L2、L3干部及其专业级证书和专业级科目二通过情况 -->
    <select id="getL2L3CadreWithCertInfo" resultType="com.huawei.aitransform.entity.CadreQualificationVO">
        SELECT 
            c.account AS employeeNumber,
            COALESCE(c.position_ai_maturity, '未知') AS aiMaturity,
            COALESCE(c.cadre_competence_category, '未知') AS jobCategory,
            CASE 
                WHEN cert.employee_number IS NOT NULL THEN 1 
                ELSE 0 
            END AS hasProfessionalCert,
            CASE 
                WHEN exam.emp_num IS NOT NULL THEN 1 
                ELSE 0 
            END AS hasPassedProfessionalSubject2
        FROM t_cadre c
        INNER JOIN t_employee_sync e ON (e.employee_number = c.account)
        LEFT JOIN (
            SELECT DISTINCT
                employee_number
            FROM dwr_t_cert_record_t
            WHERE (status = 1 OR approved_status = 1)
            AND (
                -- 华为研究类能力认证（专业级，xxx）
                cer_title = '华为研究类能力认证（专业级，AI算法技术）'
                OR cer_title = '华为研究类能力认证（专业级，AI决策推理）'
                OR cer_title = '华为研究类能力认证（专业级，AI图像语言语义）'
            )
            AND employee_number IS NOT NULL
                    AND employee_number != ''
        ) cert ON (e.employee_number = cert.employee_number)
        LEFT JOIN (
            SELECT DISTINCT emp_num
            FROM t_exam_record
            WHERE exam_code IN ('EXCN022303075ZA20', 'EXCN022303075ZA2E', 'EXCN022303075ZA2A')
            AND is_pass = 1
            AND emp_num IS NOT NULL
            AND emp_num != ''
        ) exam ON (e.employee_number = exam.emp_num)
        WHERE c.position_ai_maturity IN ('L2', 'L3')
        AND c.account IS NOT NULL
        AND c.account != ''
        AND e.period_id = 20251126
        ORDER BY c.account
    </select>

    <!-- 统计各三级部门的干部岗位数据 -->
    <select id="getL3DepartmentPositionStatistics" resultType="com.huawei.aitransform.entity.DepartmentPositionStatisticsVO">
        SELECT 
            MAX(l3_dept.dept_code) AS deptCode,
            MAX(l3_dept.dept_name) AS deptName,
            'L3' AS deptLevel,
            COUNT(*) AS totalPositionCount,
            SUM(CASE WHEN c.position_ai_maturity IN ('L2', 'L3') THEN 1 ELSE 0 END) AS l2L3PositionCount,
            CASE 
                WHEN COUNT(*) = 0 THEN 0.0
                ELSE ROUND(SUM(CASE WHEN c.position_ai_maturity IN ('L2', 'L3') THEN 1 ELSE 0 END) * 1.0 / COUNT(*), 4)
            END AS l2L3PositionRatio
        FROM t_cadre c
        INNER JOIN department_info_hrms dept ON (c.mini_departname_id = dept.dept_code AND DATE(dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d1 ON (dept.parent_dept_code = d1.dept_code AND DATE(d1.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d2 ON (d1.parent_dept_code = d2.dept_code AND DATE(d2.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d3 ON (d2.parent_dept_code = d3.dept_code AND DATE(d3.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms l3_dept ON (
            (
                (dept.dept_level = '3' AND l3_dept.dept_code = dept.dept_code)
                OR (d1.dept_level = '3' AND l3_dept.dept_code = d1.dept_code)
                OR (d2.dept_level = '3' AND l3_dept.dept_code = d2.dept_code)
                OR (d3.dept_level = '3' AND l3_dept.dept_code = d3.dept_code)
            )
            AND DATE(l3_dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms)
        )
        <where>
            <if test="deptCodes != null and deptCodes.size() > 0">
                c.mini_departname_id IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </if>
            AND l3_dept.dept_code IS NOT NULL
        </where>
        GROUP BY l3_dept.dept_code
        ORDER BY l3_dept.dept_code
    </select>

    <!-- 统计各三级部门的L2干部数据（按软件类/非软件类） -->
    <select id="getL3DepartmentL2Statistics" resultType="com.huawei.aitransform.entity.DepartmentL2L3StatisticsVO">
        SELECT 
            MAX(l3_dept.dept_code) AS deptCode,
            COUNT(*) AS l2TotalCount,
            SUM(CASE WHEN c.cadre_competence_category = '软件类' THEN 1 ELSE 0 END) AS l2SoftwareCount,
            SUM(CASE WHEN c.cadre_competence_category != '软件类' OR c.cadre_competence_category IS NULL THEN 1 ELSE 0 END) AS l2NonSoftwareCount
        FROM t_cadre c
        INNER JOIN department_info_hrms dept ON (c.mini_departname_id = dept.dept_code AND DATE(dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d1 ON (dept.parent_dept_code = d1.dept_code AND DATE(d1.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d2 ON (d1.parent_dept_code = d2.dept_code AND DATE(d2.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d3 ON (d2.parent_dept_code = d3.dept_code AND DATE(d3.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms l3_dept ON (
            (
                (dept.dept_level = '3' AND l3_dept.dept_code = dept.dept_code)
                OR (d1.dept_level = '3' AND l3_dept.dept_code = d1.dept_code)
                OR (d2.dept_level = '3' AND l3_dept.dept_code = d2.dept_code)
                OR (d3.dept_level = '3' AND l3_dept.dept_code = d3.dept_code)
            )
            AND DATE(l3_dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms)
        )
        <where>
            <if test="deptCodes != null and deptCodes.size() > 0">
                c.mini_departname_id IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </if>
            AND c.position_ai_maturity = 'L2'
            AND l3_dept.dept_code IS NOT NULL
        </where>
        GROUP BY l3_dept.dept_code
        ORDER BY l3_dept.dept_code
    </select>

    <!-- 统计各三级部门的L3干部数据（按软件类/非软件类） -->
    <select id="getL3DepartmentL3Statistics" resultType="com.huawei.aitransform.entity.DepartmentL2L3StatisticsVO">
        SELECT 
            MAX(l3_dept.dept_code) AS deptCode,
            COUNT(*) AS l3TotalCount,
            SUM(CASE WHEN c.cadre_competence_category = '软件类' THEN 1 ELSE 0 END) AS l3SoftwareCount,
            SUM(CASE WHEN c.cadre_competence_category != '软件类' OR c.cadre_competence_category IS NULL THEN 1 ELSE 0 END) AS l3NonSoftwareCount
        FROM t_cadre c
        INNER JOIN department_info_hrms dept ON (c.mini_departname_id = dept.dept_code AND DATE(dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d1 ON (dept.parent_dept_code = d1.dept_code AND DATE(d1.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d2 ON (d1.parent_dept_code = d2.dept_code AND DATE(d2.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d3 ON (d2.parent_dept_code = d3.dept_code AND DATE(d3.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms l3_dept ON (
            (
                (dept.dept_level = '3' AND l3_dept.dept_code = dept.dept_code)
                OR (d1.dept_level = '3' AND l3_dept.dept_code = d1.dept_code)
                OR (d2.dept_level = '3' AND l3_dept.dept_code = d2.dept_code)
                OR (d3.dept_level = '3' AND l3_dept.dept_code = d3.dept_code)
            )
            AND DATE(l3_dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms)
        )
        <where>
            <if test="deptCodes != null and deptCodes.size() > 0">
                c.mini_departname_id IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </if>
            AND c.position_ai_maturity = 'L3'
            AND l3_dept.dept_code IS NOT NULL
        </where>
        GROUP BY l3_dept.dept_code
        ORDER BY l3_dept.dept_code
    </select>

    <!-- 统计各四级部门的干部岗位数据 -->
    <select id="getL4DepartmentPositionStatistics" resultType="com.huawei.aitransform.entity.DepartmentPositionStatisticsVO">
        SELECT 
            MAX(l4_dept.dept_code) AS deptCode,
            MAX(l4_dept.dept_name) AS deptName,
            'L4' AS deptLevel,
            COUNT(*) AS totalPositionCount,
            SUM(CASE WHEN c.position_ai_maturity IN ('L2', 'L3') THEN 1 ELSE 0 END) AS l2L3PositionCount,
            CASE 
                WHEN COUNT(*) = 0 THEN 0.0
                ELSE ROUND(SUM(CASE WHEN c.position_ai_maturity IN ('L2', 'L3') THEN 1 ELSE 0 END) * 1.0 / COUNT(*), 4)
            END AS l2L3PositionRatio
        FROM t_cadre c
        INNER JOIN department_info_hrms dept ON (c.mini_departname_id = dept.dept_code AND DATE(dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d1 ON (dept.parent_dept_code = d1.dept_code AND DATE(d1.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d2 ON (d1.parent_dept_code = d2.dept_code AND DATE(d2.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms l4_dept ON (
            (
                (dept.dept_level = '4' AND l4_dept.dept_code = dept.dept_code)
                OR (d1.dept_level = '4' AND l4_dept.dept_code = d1.dept_code)
                OR (d2.dept_level = '4' AND l4_dept.dept_code = d2.dept_code)
            )
            AND DATE(l4_dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms)
        )
        <where>
            <if test="deptCodes != null and deptCodes.size() > 0">
                c.mini_departname_id IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </if>
            AND l4_dept.dept_code IS NOT NULL
        </where>
        GROUP BY l4_dept.dept_code
        ORDER BY l4_dept.dept_code
    </select>

    <!-- 统计各四级部门的L2干部数据（按软件类/非软件类） -->
    <select id="getL4DepartmentL2Statistics" resultType="com.huawei.aitransform.entity.DepartmentL2L3StatisticsVO">
        SELECT 
            MAX(l4_dept.dept_code) AS deptCode,
            COUNT(*) AS l2TotalCount,
            SUM(CASE WHEN c.cadre_competence_category = '软件类' THEN 1 ELSE 0 END) AS l2SoftwareCount,
            SUM(CASE WHEN c.cadre_competence_category != '软件类' OR c.cadre_competence_category IS NULL THEN 1 ELSE 0 END) AS l2NonSoftwareCount
        FROM t_cadre c
        INNER JOIN department_info_hrms dept ON (c.mini_departname_id = dept.dept_code AND DATE(dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d1 ON (dept.parent_dept_code = d1.dept_code AND DATE(d1.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d2 ON (d1.parent_dept_code = d2.dept_code AND DATE(d2.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms l4_dept ON (
            (
                (dept.dept_level = '4' AND l4_dept.dept_code = dept.dept_code)
                OR (d1.dept_level = '4' AND l4_dept.dept_code = d1.dept_code)
                OR (d2.dept_level = '4' AND l4_dept.dept_code = d2.dept_code)
            )
            AND DATE(l4_dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms)
        )
        <where>
            <if test="deptCodes != null and deptCodes.size() > 0">
                c.mini_departname_id IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </if>
            AND c.position_ai_maturity = 'L2'
            AND l4_dept.dept_code IS NOT NULL
        </where>
        GROUP BY l4_dept.dept_code
        ORDER BY l4_dept.dept_code
    </select>

    <!-- 统计各四级部门的L3干部数据（按软件类/非软件类） -->
    <select id="getL4DepartmentL3Statistics" resultType="com.huawei.aitransform.entity.DepartmentL2L3StatisticsVO">
        SELECT 
            MAX(l4_dept.dept_code) AS deptCode,
            COUNT(*) AS l3TotalCount,
            SUM(CASE WHEN c.cadre_competence_category = '软件类' THEN 1 ELSE 0 END) AS l3SoftwareCount,
            SUM(CASE WHEN c.cadre_competence_category != '软件类' OR c.cadre_competence_category IS NULL THEN 1 ELSE 0 END) AS l3NonSoftwareCount
        FROM t_cadre c
        INNER JOIN department_info_hrms dept ON (c.mini_departname_id = dept.dept_code AND DATE(dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d1 ON (dept.parent_dept_code = d1.dept_code AND DATE(d1.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d2 ON (d1.parent_dept_code = d2.dept_code AND DATE(d2.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms l4_dept ON (
            (
                (dept.dept_level = '4' AND l4_dept.dept_code = dept.dept_code)
                OR (d1.dept_level = '4' AND l4_dept.dept_code = d1.dept_code)
                OR (d2.dept_level = '4' AND l4_dept.dept_code = d2.dept_code)
            )
            AND DATE(l4_dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms)
        )
        <where>
            <if test="deptCodes != null and deptCodes.size() > 0">
                c.mini_departname_id IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </if>
            AND c.position_ai_maturity = 'L3'
            AND l4_dept.dept_code IS NOT NULL
        </where>
        GROUP BY l4_dept.dept_code
        ORDER BY l4_dept.dept_code
    </select>

    <!-- 统计汇总数据（云核心网产品线下所有三级部门，不包括研发管理部下的四级部门） -->
    <select id="getSummaryPositionStatistics" resultType="com.huawei.aitransform.entity.SummaryStatisticsVO">
        SELECT 
            COUNT(*) AS totalPositionCount,
            SUM(CASE WHEN c.position_ai_maturity IN ('L2', 'L3') THEN 1 ELSE 0 END) AS l2L3PositionCount,
            CASE 
                WHEN COUNT(*) = 0 THEN 0.0
                ELSE ROUND(SUM(CASE WHEN c.position_ai_maturity IN ('L2', 'L3') THEN 1 ELSE 0 END) * 1.0 / COUNT(*), 4)
            END AS l2L3PositionRatio
        FROM t_cadre c
        INNER JOIN department_info_hrms dept ON (c.mini_departname_id = dept.dept_code AND DATE(dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d1 ON (dept.parent_dept_code = d1.dept_code AND DATE(d1.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d2 ON (d1.parent_dept_code = d2.dept_code AND DATE(d2.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d3 ON (d2.parent_dept_code = d3.dept_code AND DATE(d3.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms l3_dept ON (
            (
                (dept.dept_level = '3' AND l3_dept.dept_code = dept.dept_code)
                OR (d1.dept_level = '3' AND l3_dept.dept_code = d1.dept_code)
                OR (d2.dept_level = '3' AND l3_dept.dept_code = d2.dept_code)
                OR (d3.dept_level = '3' AND l3_dept.dept_code = d3.dept_code)
            )
            AND DATE(l3_dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms)
        )
        LEFT JOIN department_info_hrms l4_dept ON (
            (
                (dept.dept_level = '4' AND l4_dept.dept_code = dept.dept_code)
                OR (d1.dept_level = '4' AND l4_dept.dept_code = d1.dept_code)
                OR (d2.dept_level = '4' AND l4_dept.dept_code = d2.dept_code)
            )
            AND DATE(l4_dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms)
        )
        <where>
            <if test="deptCodes != null and deptCodes.size() > 0">
                c.mini_departname_id IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </if>
            AND (
                (l3_dept.dept_code != '030681')
                OR
                (l3_dept.dept_code = '030681' AND l4_dept.dept_code IS NULL)
            )
            <if test="excludeL4DeptCodes != null and excludeL4DeptCodes.size() > 0">
                AND (
                    l4_dept.dept_code IS NULL
                    OR l4_dept.dept_code NOT IN
                    <foreach collection="excludeL4DeptCodes" item="deptCode" open="(" separator="," close=")">
                        #{deptCode}
                    </foreach>
                )
            </if>
        </where>
    </select>

    <!-- 统计汇总的L2干部数据（按软件类/非软件类） -->
    <select id="getSummaryL2Statistics" resultType="com.huawei.aitransform.entity.L2L3StatisticsVO">
        SELECT 
            COUNT(*) AS totalCount,
            SUM(CASE WHEN c.cadre_competence_category = '软件类' THEN 1 ELSE 0 END) AS softwareCount,
            SUM(CASE WHEN c.cadre_competence_category != '软件类' OR c.cadre_competence_category IS NULL THEN 1 ELSE 0 END) AS nonSoftwareCount
        FROM t_cadre c
        INNER JOIN department_info_hrms dept ON (c.mini_departname_id = dept.dept_code AND DATE(dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d1 ON (dept.parent_dept_code = d1.dept_code AND DATE(d1.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d2 ON (d1.parent_dept_code = d2.dept_code AND DATE(d2.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d3 ON (d2.parent_dept_code = d3.dept_code AND DATE(d3.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms l3_dept ON (
            (
                (dept.dept_level = '3' AND l3_dept.dept_code = dept.dept_code)
                OR (d1.dept_level = '3' AND l3_dept.dept_code = d1.dept_code)
                OR (d2.dept_level = '3' AND l3_dept.dept_code = d2.dept_code)
                OR (d3.dept_level = '3' AND l3_dept.dept_code = d3.dept_code)
            )
            AND DATE(l3_dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms)
        )
        LEFT JOIN department_info_hrms l4_dept ON (
            (
                (dept.dept_level = '4' AND l4_dept.dept_code = dept.dept_code)
                OR (d1.dept_level = '4' AND l4_dept.dept_code = d1.dept_code)
                OR (d2.dept_level = '4' AND l4_dept.dept_code = d2.dept_code)
            )
            AND DATE(l4_dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms)
        )
        <where>
            c.position_ai_maturity = 'L2'
            <if test="deptCodes != null and deptCodes.size() > 0">
                AND c.mini_departname_id IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </if>
            AND (
                (l3_dept.dept_code != '030681')
                OR
                (l3_dept.dept_code = '030681' AND l4_dept.dept_code IS NULL)
            )
            <if test="excludeL4DeptCodes != null and excludeL4DeptCodes.size() > 0">
                AND (
                    l4_dept.dept_code IS NULL
                    OR l4_dept.dept_code NOT IN
                    <foreach collection="excludeL4DeptCodes" item="deptCode" open="(" separator="," close=")">
                        #{deptCode}
                    </foreach>
                )
            </if>
        </where>
    </select>

    <!-- 统计汇总的L3干部数据（按软件类/非软件类） -->
    <select id="getSummaryL3Statistics" resultType="com.huawei.aitransform.entity.L2L3StatisticsVO">
        SELECT 
            COUNT(*) AS totalCount,
            SUM(CASE WHEN c.cadre_competence_category = '软件类' THEN 1 ELSE 0 END) AS softwareCount,
            SUM(CASE WHEN c.cadre_competence_category != '软件类' OR c.cadre_competence_category IS NULL THEN 1 ELSE 0 END) AS nonSoftwareCount
        FROM t_cadre c
        INNER JOIN department_info_hrms dept ON (c.mini_departname_id = dept.dept_code AND DATE(dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d1 ON (dept.parent_dept_code = d1.dept_code AND DATE(d1.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d2 ON (d1.parent_dept_code = d2.dept_code AND DATE(d2.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d3 ON (d2.parent_dept_code = d3.dept_code AND DATE(d3.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms l3_dept ON (
            (
                (dept.dept_level = '3' AND l3_dept.dept_code = dept.dept_code)
                OR (d1.dept_level = '3' AND l3_dept.dept_code = d1.dept_code)
                OR (d2.dept_level = '3' AND l3_dept.dept_code = d2.dept_code)
                OR (d3.dept_level = '3' AND l3_dept.dept_code = d3.dept_code)
            )
            AND DATE(l3_dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms)
        )
        LEFT JOIN department_info_hrms l4_dept ON (
            (
                (dept.dept_level = '4' AND l4_dept.dept_code = dept.dept_code)
                OR (d1.dept_level = '4' AND l4_dept.dept_code = d1.dept_code)
                OR (d2.dept_level = '4' AND l4_dept.dept_code = d2.dept_code)
            )
            AND DATE(l4_dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms)
        )
        <where>
            c.position_ai_maturity = 'L3'
            <if test="deptCodes != null and deptCodes.size() > 0">
                AND c.mini_departname_id IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </if>
            AND (
                (l3_dept.dept_code != '030681')
                OR
                (l3_dept.dept_code = '030681' AND l4_dept.dept_code IS NULL)
            )
            <if test="excludeL4DeptCodes != null and excludeL4DeptCodes.size() > 0">
                AND (
                    l4_dept.dept_code IS NULL
                    OR l4_dept.dept_code NOT IN
                    <foreach collection="excludeL4DeptCodes" item="deptCode" open="(" separator="," close=")">
                        #{deptCode}
                    </foreach>
                )
            </if>
        </where>
    </select>

    <!-- 统计研发管理部下所有四级部门的汇总数据 -->
    <select id="getL4SummaryPositionStatistics" resultType="com.huawei.aitransform.entity.SummaryStatisticsVO">
        SELECT 
            COUNT(*) AS totalPositionCount,
            SUM(CASE WHEN c.position_ai_maturity IN ('L2', 'L3') THEN 1 ELSE 0 END) AS l2L3PositionCount,
            CASE 
                WHEN COUNT(*) = 0 THEN 0.0
                ELSE ROUND(SUM(CASE WHEN c.position_ai_maturity IN ('L2', 'L3') THEN 1 ELSE 0 END) * 1.0 / COUNT(*), 4)
            END AS l2L3PositionRatio
        FROM t_cadre c
        INNER JOIN department_info_hrms dept ON (c.mini_departname_id = dept.dept_code AND DATE(dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d1 ON (dept.parent_dept_code = d1.dept_code AND DATE(d1.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d2 ON (d1.parent_dept_code = d2.dept_code AND DATE(d2.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms l3_dept ON (
            (
                (dept.dept_level = '3' AND l3_dept.dept_code = dept.dept_code)
                OR (d1.dept_level = '3' AND l3_dept.dept_code = d1.dept_code)
                OR (d2.dept_level = '3' AND l3_dept.dept_code = d2.dept_code)
            )
            AND DATE(l3_dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms)
        )
        LEFT JOIN department_info_hrms l4_dept ON (
            (
                (dept.dept_level = '4' AND l4_dept.dept_code = dept.dept_code)
                OR (d1.dept_level = '4' AND l4_dept.dept_code = d1.dept_code)
                OR (d2.dept_level = '4' AND l4_dept.dept_code = d2.dept_code)
            )
            AND DATE(l4_dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms)
        )
        <where>
            <if test="deptCodes != null and deptCodes.size() > 0">
                c.mini_departname_id IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </if>
            AND l3_dept.dept_code = '030681'
            AND l4_dept.dept_code IS NOT NULL
        </where>
    </select>

    <!-- 统计研发管理部下所有四级部门的L2汇总数据 -->
    <select id="getL4SummaryL2Statistics" resultType="com.huawei.aitransform.entity.L2L3StatisticsVO">
        SELECT 
            COUNT(*) AS totalCount,
            SUM(CASE WHEN c.cadre_competence_category = '软件类' THEN 1 ELSE 0 END) AS softwareCount,
            SUM(CASE WHEN c.cadre_competence_category != '软件类' OR c.cadre_competence_category IS NULL THEN 1 ELSE 0 END) AS nonSoftwareCount
        FROM t_cadre c
        INNER JOIN department_info_hrms dept ON (c.mini_departname_id = dept.dept_code AND DATE(dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d1 ON (dept.parent_dept_code = d1.dept_code AND DATE(d1.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d2 ON (d1.parent_dept_code = d2.dept_code AND DATE(d2.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms l3_dept ON (
            (
                (dept.dept_level = '3' AND l3_dept.dept_code = dept.dept_code)
                OR (d1.dept_level = '3' AND l3_dept.dept_code = d1.dept_code)
                OR (d2.dept_level = '3' AND l3_dept.dept_code = d2.dept_code)
            )
            AND DATE(l3_dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms)
        )
        LEFT JOIN department_info_hrms l4_dept ON (
            (
                (dept.dept_level = '4' AND l4_dept.dept_code = dept.dept_code)
                OR (d1.dept_level = '4' AND l4_dept.dept_code = d1.dept_code)
                OR (d2.dept_level = '4' AND l4_dept.dept_code = d2.dept_code)
            )
            AND DATE(l4_dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms)
        )
        <where>
            c.position_ai_maturity = 'L2'
            <if test="deptCodes != null and deptCodes.size() > 0">
                AND c.mini_departname_id IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </if>
            AND l3_dept.dept_code = '030681'
            AND l4_dept.dept_code IS NOT NULL
        </where>
    </select>

    <!-- 统计研发管理部下所有四级部门的L3汇总数据 -->
    <select id="getL4SummaryL3Statistics" resultType="com.huawei.aitransform.entity.L2L3StatisticsVO">
        SELECT 
            COUNT(*) AS totalCount,
            SUM(CASE WHEN c.cadre_competence_category = '软件类' THEN 1 ELSE 0 END) AS softwareCount,
            SUM(CASE WHEN c.cadre_competence_category != '软件类' OR c.cadre_competence_category IS NULL THEN 1 ELSE 0 END) AS nonSoftwareCount
        FROM t_cadre c
        INNER JOIN department_info_hrms dept ON (c.mini_departname_id = dept.dept_code AND DATE(dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d1 ON (dept.parent_dept_code = d1.dept_code AND DATE(d1.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms d2 ON (d1.parent_dept_code = d2.dept_code AND DATE(d2.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms))
        LEFT JOIN department_info_hrms l3_dept ON (
            (
                (dept.dept_level = '3' AND l3_dept.dept_code = dept.dept_code)
                OR (d1.dept_level = '3' AND l3_dept.dept_code = d1.dept_code)
                OR (d2.dept_level = '3' AND l3_dept.dept_code = d2.dept_code)
            )
            AND DATE(l3_dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms)
        )
        LEFT JOIN department_info_hrms l4_dept ON (
            (
                (dept.dept_level = '4' AND l4_dept.dept_code = dept.dept_code)
                OR (d1.dept_level = '4' AND l4_dept.dept_code = d1.dept_code)
                OR (d2.dept_level = '4' AND l4_dept.dept_code = d2.dept_code)
            )
            AND DATE(l4_dept.update_time) = (SELECT MAX(DATE(update_time)) FROM department_info_hrms)
        )
        <where>
            c.position_ai_maturity = 'L3'
            <if test="deptCodes != null and deptCodes.size() > 0">
                AND c.mini_departname_id IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </if>
            AND l3_dept.dept_code = '030681'
            AND l4_dept.dept_code IS NOT NULL
        </where>
    </select>

</mapper>

