<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.huawei.aitransform.mapper.CadreMapper">

    <!-- 根据部门编码列表查询干部工号列表 -->
    <!-- 只匹配最小部门编码（mini_departname_id）字段 -->
    <select id="getCadreEmployeeNumbersByDeptCodes" resultType="java.lang.String">
        SELECT DISTINCT account
        FROM t_cadre
        <where>
            <if test="deptCodes != null and deptCodes.size() > 0">
                mini_departname_id IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </if>
            AND account IS NOT NULL
            AND account != ''
        </where>
    </select>

    <!-- 根据部门编码列表查询干部工号和职位类 -->
    <!-- 只匹配最小部门编码（mini_departname_id）字段 -->
    <select id="getCadreEmployeesWithCategoryByDeptCodes" resultType="com.huawei.aitransform.entity.EmployeeWithCategoryVO">
        SELECT DISTINCT
            account AS employeeNumber,
            COALESCE(cadre_competence_category, '未知') AS competenceCategory
        FROM t_cadre
        <where>
            <if test="deptCodes != null and deptCodes.size() > 0">
                mini_departname_id IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </if>
            AND account IS NOT NULL
            AND account != ''
        </where>
    </select>

    <!-- 根据部门编码列表查询干部信息（工号、部门编码、职位类、AI成熟度） -->
    <!-- 只匹配最小部门编码（mini_departname_id）字段 -->
    <select id="getCadreInfoByDeptCodes" resultType="com.huawei.aitransform.entity.CadreInfoVO">
        SELECT DISTINCT
            account AS employeeNumber,
            mini_departname_id AS deptCode,
            COALESCE(cadre_competence_category, '未知') AS jobCategory,
            COALESCE(position_ai_maturity, '未知') AS aiMaturity
        FROM t_cadre
        <where>
            <if test="deptCodes != null and deptCodes.size() > 0">
                mini_departname_id IN
                <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                    #{deptCode}
                </foreach>
            </if>
            AND account IS NOT NULL
            AND account != ''
        </where>
    </select>

    <!-- 根据部门编码列表、AI成熟度和职位类查询干部认证详细信息 -->
    <select id="getCadreCertDetailsByConditions" resultType="com.huawei.aitransform.entity.EmployeeDetailVO">
        SELECT DISTINCT
            e.cn_name AS name,
            SUBSTRING(e.account, 2) AS employeeNumber,
            e.competence_category AS competenceCategory,
            e.competence_subcategory AS competenceSubcategory,
            e.departname2,
            e.departname3,
            e.departname4,
            e.departname5,
            e.departname6,
            cert.cer_title AS certTitle,
            cert.start_time AS certStartTime,
            CASE 
                WHEN exam.emp_num IS NOT NULL THEN 1 
                ELSE 0 
            END AS isPassedSubject2,
            1 AS isCadre,
            COALESCE(c.position_ai_maturity, '未知') AS aiMaturity,
            dept.dept_name AS miniDeptName
        FROM t_cadre c
        INNER JOIN t_employee e ON (SUBSTRING(e.account, 2) = c.account)
        INNER JOIN (
            SELECT DISTINCT
                COALESCE(employee_number, w3_account) AS employee_number,
                w3_account,
                cer_title,
                start_time
            FROM dwr_t_cert_record_t
            WHERE (status = 1 OR approved_status = 1)
            AND (
                -- 华为研究类能力认证（专业级，xxx）
                cer_title = '华为研究类能力认证（专业级，AI算法技术）'
                OR cer_title = '华为研究类能力认证（专业级，AI决策推理）'
                OR cer_title = '华为研究类能力认证（专业级，AI图像语言语义）'
            )
        ) cert ON (e.account = cert.employee_number OR e.account = cert.w3_account)
        LEFT JOIN (
            SELECT DISTINCT emp_num
            FROM t_exam_record
            WHERE exam_name IS NOT NULL
            AND exam_name != ''
            AND is_pass = 1
            AND emp_num IS NOT NULL
            AND emp_num != ''
        ) exam ON (e.sn = exam.emp_num)
        LEFT JOIN department_info_hrms dept ON (c.mini_departname_id = dept.dept_code AND DATE(dept.update_time) = '2025-11-18')
        WHERE e.expired_date IS NULL
        <if test="deptCodes != null and deptCodes.size() > 0">
            AND c.mini_departname_id IN
            <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                #{deptCode}
            </foreach>
        </if>
        <if test="aiMaturity != null and aiMaturity != ''">
            AND COALESCE(c.position_ai_maturity, '未知') = #{aiMaturity}
        </if>
        <if test="jobCategory != null and jobCategory != ''">
            AND COALESCE(c.cadre_competence_category, '未知') = #{jobCategory}
        </if>
        AND c.account IS NOT NULL
        AND c.account != ''
        AND e.account IS NOT NULL
        AND e.account != ''
        AND e.account REGEXP '^[a-z]0[0-9]{7}$'
        ORDER BY e.account
    </select>

    <!-- 根据部门编码列表、AI成熟度和职位类查询干部任职详细信息 -->
    <!-- queryType=1: 查询有AI相关任职的人员信息 -->
    <!-- queryType=2: 查询符合条件的所有成员，即使没有AI任职信息也显示人员信息，AI任职信息为空 -->
    <!-- 每人最多显示一条信息，如果有多条AI任职结果，选取任职级别最高的一条展示 -->
    <select id="getCadreQualifiedDetailsByConditions" resultType="com.huawei.aitransform.entity.EmployeeDetailVO">
        SELECT DISTINCT
            e.cn_name AS name,
            SUBSTRING(e.account, 2) AS employeeNumber,
            e.competence_category AS competenceCategory,
            e.competence_subcategory AS competenceSubcategory,
            e.departname2,
            e.departname3,
            e.departname4,
            e.departname5,
            e.departname6,
            q.competence_family_cn AS competenceFamilyCn,
            q.competence_category_cn AS competenceCategoryCn,
            q.competence_subcategory_cn AS competenceSubcategoryCn,
            q.direction_cn_name AS directionCnName,
            q.competence_rating_cn AS competenceRatingCn,
            q.competence_grade_cn AS competenceGradeCn,
            q.competence_from AS competenceFrom,
            q.competence_to AS competenceTo,
            COALESCE(c.position_ai_maturity, '未知') AS aiMaturity,
            1 AS isCadre,
            dept.dept_name AS miniDeptName,
            c.cadre_type AS cadreType
        FROM t_cadre c
        INNER JOIN t_employee e ON (SUBSTRING(e.account, 2) = c.account)
        <choose>
            <when test="queryType != null and queryType == 2">
                <!-- queryType=2: 使用 LEFT JOIN，返回所有人员，即使没有AI任职也显示 -->
                LEFT JOIN t_qualifications q ON (
                    c.account = q.employee_number
                    AND q.employee_number IS NOT NULL
                    AND q.employee_number != ''
                    AND q.direction_cn_name IN (
                        '数据科学与AI工程（ICT）',
                        'AI算法及应用（ICT）',
                        'AI软件工程与工具（ICT）',
                        'AI系统测试（ICT）'
                    )
                    AND q.competence_from IS NOT NULL
                    AND q.competence_to IS NOT NULL
                    AND q.competence_from = (
                        -- 子查询：找到每个员工最高级别的AI任职记录的competence_from
                        SELECT q2.competence_from
                        FROM t_qualifications q2
                        WHERE q2.employee_number = c.account
                        AND q2.employee_number IS NOT NULL
                        AND q2.employee_number != ''
                        AND q2.direction_cn_name IN (
                            '数据科学与AI工程（ICT）',
                            'AI算法及应用（ICT）',
                            'AI软件工程与工具（ICT）',
                            'AI系统测试（ICT）'
                        )
                        AND q2.competence_from IS NOT NULL
                        AND q2.competence_to IS NOT NULL
                        ORDER BY 
                            CASE 
                                WHEN q2.competence_rating_cn LIKE '%专家%' OR q2.competence_rating_cn LIKE '%L5%' THEN 1
                                WHEN q2.competence_rating_cn LIKE '%高级%' OR q2.competence_rating_cn LIKE '%L4%' THEN 2
                                WHEN q2.competence_rating_cn LIKE '%中级%' OR q2.competence_rating_cn LIKE '%L3%' THEN 3
                                WHEN q2.competence_rating_cn LIKE '%初级%' OR q2.competence_rating_cn LIKE '%L2%' THEN 4
                                WHEN q2.competence_rating_cn LIKE '%L1%' THEN 5
                                ELSE 6
                            END,
                            q2.competence_from DESC
                        LIMIT 1
                    )
                )
            </when>
            <otherwise>
                <!-- queryType=1: 使用 INNER JOIN，只返回有AI任职记录的干部 -->
                INNER JOIN t_qualifications q ON (
                    c.account = q.employee_number
                    AND q.employee_number IS NOT NULL
                    AND q.employee_number != ''
                    AND q.direction_cn_name IN (
                        '数据科学与AI工程（ICT）',
                        'AI算法及应用（ICT）',
                        'AI软件工程与工具（ICT）',
                        'AI系统测试（ICT）'
                    )
                    AND q.competence_from IS NOT NULL
                    AND q.competence_to IS NOT NULL
                    AND q.competence_from = (
                        -- 子查询：找到每个员工最高级别的AI任职记录的competence_from
                        SELECT q2.competence_from
                        FROM t_qualifications q2
                        WHERE q2.employee_number = c.account
                        AND q2.employee_number IS NOT NULL
                        AND q2.employee_number != ''
                        AND q2.direction_cn_name IN (
                            '数据科学与AI工程（ICT）',
                            'AI算法及应用（ICT）',
                            'AI软件工程与工具（ICT）',
                            'AI系统测试（ICT）'
                        )
                        AND q2.competence_from IS NOT NULL
                        AND q2.competence_to IS NOT NULL
                        ORDER BY 
                            CASE 
                                WHEN q2.competence_rating_cn LIKE '%专家%' OR q2.competence_rating_cn LIKE '%L5%' THEN 1
                                WHEN q2.competence_rating_cn LIKE '%高级%' OR q2.competence_rating_cn LIKE '%L4%' THEN 2
                                WHEN q2.competence_rating_cn LIKE '%中级%' OR q2.competence_rating_cn LIKE '%L3%' THEN 3
                                WHEN q2.competence_rating_cn LIKE '%初级%' OR q2.competence_rating_cn LIKE '%L2%' THEN 4
                                WHEN q2.competence_rating_cn LIKE '%L1%' THEN 5
                                ELSE 6
                            END,
                            q2.competence_from DESC
                        LIMIT 1
                    )
                )
            </otherwise>
        </choose>
        LEFT JOIN department_info_hrms dept ON (c.mini_departname_id = dept.dept_code AND DATE(dept.update_time) = '2025-11-18')
        WHERE e.expired_date IS NULL
        <if test="deptCodes != null and deptCodes.size() > 0">
            AND c.mini_departname_id IN
            <foreach collection="deptCodes" item="deptCode" open="(" separator="," close=")">
                #{deptCode}
            </foreach>
        </if>
        <if test="aiMaturity != null and aiMaturity != ''">
            AND COALESCE(c.position_ai_maturity, '未知') = #{aiMaturity}
        </if>
        <if test="jobCategory != null and jobCategory != ''">
            AND COALESCE(c.cadre_competence_category, '未知') = #{jobCategory}
        </if>
        AND c.account IS NOT NULL
        AND c.account != ''
        AND e.account IS NOT NULL
        AND e.account != ''
        AND e.account REGEXP '^[a-z]0[0-9]{7}$'
        ORDER BY e.account
    </select>

</mapper>

